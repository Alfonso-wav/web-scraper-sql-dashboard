<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCRAPER - SQL - CANVAS</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 80px; /* Espacio para la barra de herramientas */
        }
        
        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Altura uniforme para todos los m√≥dulos */
        .row-cols-lg-2 > .col {
            min-height: 500px;
        }
        
        .overflow-auto {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }
        
        .overflow-auto::-webkit-scrollbar {
            width: 6px;
        }
        
        .overflow-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .overflow-auto::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }
        
        .overflow-auto::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        .clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .clickable:hover {
            transform: translateX(3px);
        }
        
        .sql-btn {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 4px 10px;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            left: 0;
            right: 0;
            display: none;
        }
        
        .autocomplete-suggestions.show {
            display: block;
        }
        
        .autocomplete-item {
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .autocomplete-item.selected {
            background-color: #e9ecef !important;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60%, 100% { content: '...'; }
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        /* Drag and Drop Styles */
        .draggable-module {
            cursor: default;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .draggable-module:hover {
            transform: scale(1.02);
        }
        
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .drag-over {
            border: 3px dashed #667eea !important;
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .drag-handle {
            cursor: grab;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .drag-handle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        /* Prevenir selecci√≥n al arrastrar */
        body.dragging-active,
        body.dragging-active * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
        }
        
        /* Resize functionality */
        .draggable-module {
            position: absolute;
        }
        
        .resize-handle {
            position: absolute;
            background: rgba(102, 126, 234, 0.3);
            transition: background-color 0.2s;
            z-index: 10;
        }
        
        .resize-handle:hover {
            background: rgba(102, 126, 234, 0.6);
        }
        
        .resize-right {
            right: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
        }
        
        .resize-bottom {
            left: 0;
            right: 0;
            bottom: 0;
            height: 8px;
            cursor: ns-resize;
        }
        
        .resize-corner {
            right: 0;
            bottom: 0;
            width: 16px;
            height: 16px;
            cursor: nwse-resize;
            background: rgba(102, 126, 234, 0.5);
        }
        
        .resize-corner::after {
            content: '‚ã∞';
            position: absolute;
            right: 2px;
            bottom: -2px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .resizing {
            user-select: none;
        }
        
        /* Evitar que el dropdown se cierre al hacer click en checkboxes */
        .dropdown-menu {
            cursor: default;
        }
        
        .dropdown-menu .form-check-label {
            cursor: pointer;
            user-select: none;
        }
        
        /* Personalizador visual */
        .form-control-color {
            width: 50px;
            height: 38px;
            border: 2px solid #dee2e6;
            cursor: pointer;
        }
        
        .form-control-color::-webkit-color-swatch-wrapper {
            padding: 2px;
        }
        
        .form-control-color::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }
        
        #personalizador hr {
            margin: 1rem 0;
            opacity: 0.1;
        }
        
        /* Barra de herramientas minimizada */
        .minimized-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d2d2d;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 0.75rem 1.5rem;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        .minimized-toolbar.hidden {
            transform: translateY(100%);
        }
        
        .toolbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .toolbar-title {
            color: white;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        
        .minimized-modules-list {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex: 1;
        }
        
        .minimized-module-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #667eea;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
        }
        
        .minimized-module-btn:active {
            cursor: grabbing;
        }
        
        .minimized-module-btn.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .minimized-module-btn.drag-over {
            transform: translateX(5px);
            background: rgba(102, 126, 234, 0.2);
        }
        
        .minimized-module-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-color: white;
        }
        
        .minimized-module-btn i {
            font-size: 18px;
        }
        
        .minimized-module-btn:active {
            transform: translateY(0);
        }
        
        /* Animaci√≥n para m√≥dulos minimizados */
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .minimized-module-btn.new {
            animation: slideInFromBottom 0.4s ease;
        }
        
        /* Men√∫ contextual */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            min-width: 180px;
            padding: 0.25rem 0;
        }
        
        .context-menu-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 14px;
            color: #333;
            transition: all 0.2s;
        }
        
        .context-menu-item:hover {
            background: #f0f0f0;
            color: #667eea;
        }
        
        .context-menu-item i {
            font-size: 16px;
        }
        
        /* Visualizador de im√°genes - Estilos para im√°genes en el board */
        .board-image {
            position: absolute;
            cursor: move;
            border: 2px solid transparent;
            transition: border-color 0.2s, box-shadow 0.2s;
            user-select: none;
            max-width: none;
        }
        
        .board-image:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .board-image.selected {
            border-color: #764ba2;
            box-shadow: 0 6px 20px rgba(118, 75, 162, 0.5);
        }
        
        .board-image.dragging-board {
            opacity: 0.7;
            cursor: grabbing;
        }
        
        .board-image-controls {
            position: absolute;
            top: -32px;
            right: 0;
            display: none;
            gap: 4px;
            background: rgba(255, 255, 255, 0.95);
            padding: 4px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .board-image:hover .board-image-controls,
        .board-image.selected .board-image-controls {
            display: flex;
        }
        
        .board-resize-handle {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
            bottom: -7px;
            right: -7px;
            display: none;
            z-index: 11;
        }
        
        .board-image:hover .board-resize-handle,
        .board-image.selected .board-resize-handle {
            display: block;
        }
        
        /* Canvas de trabajo infinito */
        #workspaceCanvas {
            background-color: #f8f9fa;
            background-image: 
                linear-gradient(rgba(0, 0, 0, .03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, .03) 1px, transparent 1px);
            background-size: 50px 50px;
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.05);
            overflow: auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }
        
        #workspaceCanvas::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        #workspaceCanvas::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #workspaceCanvas::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        #workspaceCanvas::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        /* Indicador de canvas */
        .canvas-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* M√≥dulos de imagen arrastrable */
        .image-module {
            cursor: move;
            transition: transform 0.2s;
        }
        
        .image-module:hover {
            transform: scale(1.05);
        }
        
        .image-module.dragging {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body gradient-header text-white">
                <h1 class="h3 mb-2"><i class="bi bi-database"></i> SCRAPER - SQL - CANVAS</h1>
                <p class="mb-0 small">Ejecuta consultas SQL directamente sobre la base de datos de productos scraped</p>
            </div>
        </div>
        
        <!-- Canvas de trabajo infinito -->
        <div id="workspaceCanvas" style="position: relative; width: 100%; height: 85vh;">
            <div class="canvas-info">
                <i class="bi bi-grid-3x3"></i> Canvas de Trabajo
            </div>
            
            <!-- Contenedor interno para m√≥dulos (tama√±o expandible) -->
            <div id="modulesGrid" style="position: relative; min-width: 1200px; min-height: 1200px;">
            
            <!-- M√≥dulo 0: Scraper de Amazon -->
            <div class="draggable-module" draggable="false" data-module-id="scraper" data-module-name="Scraper" data-module-icon="bi-search" style="left: 20px; top: 20px; width: 600px; height: 500px;">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0"><i class="bi bi-search"></i> Scraper Multi-Plataforma</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('scraper')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <!-- Formulario de scraping -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label small">Plataforma</label>
                                <select class="form-select" id="platformSelect">
                                    <option value="amazon">üõí Amazon</option>
                                    <option value="corte_ingles">üè¨ El Corte Ingl√©s</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">T√©rmino de b√∫squeda</label>
                                <input type="text" class="form-control" id="searchTermInput" placeholder="Introduce t√©rmino de b√∫squeda (ej: auriculares gaming, cafe organico...)">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small"># Productos</label>
                                <input type="number" class="form-control" id="numProductsInput" placeholder="50" value="50" min="1">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-12">
                                <button class="btn btn-success w-100" onclick="startScraping()" id="scrapeBtn"><i class="bi bi-rocket"></i> Iniciar Scraping</button>
                            </div>
                        </div>
                        
                        <!-- Contenedor de progreso -->
                        <div class="d-none" id="progressContainer" style="overflow-y: auto;">
                            <!-- Paso 1: Scraping -->
                            <div class="card mb-3 border-start border-4 border-secondary" id="step1">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>1Ô∏è‚É£ Scraping de productos en Amazon</div>
                                        <div id="progress1-percent">0%</div>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" id="progress1-bar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="progress1-msg">Esperando...</small>
                                </div>
                            </div>
                            
                            <!-- Paso 2: JSON -->
                            <div class="card mb-3 border-start border-4 border-secondary" id="step2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>2Ô∏è‚É£ Creaci√≥n de archivo JSON</div>
                                        <div id="progress2-percent">0%</div>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" id="progress2-bar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="progress2-msg">Esperando...</small>
                                </div>
                            </div>
                            
                            <!-- Paso 3: PostgreSQL -->
                            <div class="card mb-3 border-start border-4 border-secondary" id="step3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>3Ô∏è‚É£ Subida a PostgreSQL</div>
                                        <div id="progress3-percent">0%</div>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" id="progress3-bar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="progress3-msg">Esperando...</small>
                                </div>
                            </div>
                            
                            <!-- Paso 4: Finalizar -->
                            <div class="card mb-3 border-start border-4 border-secondary" id="step4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>4Ô∏è‚É£ Finalizando proceso</div>
                                        <div id="progress4-percent">0%</div>
                                    </div>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-gradient" id="progress4-bar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="progress4-msg">Esperando...</small>
                                </div>
                            </div>
                            
                            <!-- Bot√≥n de recarga -->
                            <button class="btn btn-info d-none" id="reloadBtn" onclick="window.location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> Recargar p√°gina para ver la nueva tabla
                            </button>
                        </div>
                        
                        <div id="scraperStatus" class="d-none"></div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 1: Columnas m√°s Comunes -->
            <div class="draggable-module" draggable="false" data-module-id="columnas" data-module-name="Columnas" data-module-icon="bi-columns" style="left: 640px; top: 20px; width: 450px; height: 500px;">
                <div class="card shadow-sm h-100 d-flex flex-column">
                    <div class="card-body d-flex flex-column" style="min-height: 0;">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
                            <h5 class="card-title mb-0"><i class="bi bi-columns"></i> Columnas m√°s Comunes</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('columnas')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <!-- Filtro de tablas -->
                        <div class="mb-3 flex-shrink-0">
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary btn-sm w-100 dropdown-toggle" type="button" id="tableFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-funnel"></i> Filtrar por tabla (<span id="selectedTablesCount">Todas</span>)
                                </button>
                                <div class="dropdown-menu w-100 p-3" aria-labelledby="tableFilterDropdown" style="max-height: 300px; overflow-y: auto;">
                                    <div class="mb-2">
                                        <button class="btn btn-link btn-sm p-0" onclick="selectAllTables()">Seleccionar todas</button>
                                        <span class="mx-1">|</span>
                                        <button class="btn btn-link btn-sm p-0" onclick="clearAllTables()">Limpiar</button>
                                    </div>
                                    <hr class="my-2">
                                    <div id="tableFilterList">
                                        <!-- Se llenar√° din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <p class="small text-muted mb-3 flex-shrink-0">Click para insertar en el cursor</p>
                        <div class="flex-grow-1 overflow-auto" id="columnsListContainer" style="min-height: 0;">
                            {% for column in common_columns %}
                            <div class="list-group-item list-group-item-action clickable border-start border-3 border-primary mb-2" onclick="insertAtCursor('{{ column.name }}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-primary">{{ column.name }}</span>
                                    <span class="badge bg-light text-dark">{{ column.frequency }} tablas</span>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if not common_columns %}
                            <div class="text-muted small p-3">
                                No hay columnas disponibles. Scrape algunos productos primero.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 2: Vistas Guardadas -->
            <div class="draggable-module" draggable="false" data-module-id="vistas" data-module-name="Vistas" data-module-icon="bi-eye" style="left: 1110px; top: 20px; width: 400px; height: 500px;">
                <div class="card shadow-sm h-100 d-flex flex-column">
                    <div class="card-body d-flex flex-column" style="min-height: 0;">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
                            <h5 class="card-title mb-0"><i class="bi bi-eye"></i> Vistas Guardadas</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('vistas')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        <p class="small text-muted mb-3 flex-shrink-0">Click para usar en consulta</p>
                        <div class="flex-grow-1 overflow-auto" id="viewsList" style="min-height: 0;">
                            <div class="text-muted small p-3">
                                Cargando vistas...
                            </div>
                        </div>
                        <button class="btn btn-primary w-100 mt-3 flex-shrink-0" onclick="showCreateViewDialog()">
                            <i class="bi bi-plus-circle"></i> Crear Nueva Vista
                        </button>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 3: Editor SQL -->
            <div class="draggable-module" draggable="false" data-module-id="editor" data-module-name="Editor SQL" data-module-icon="bi-code-slash" style="left: 20px; top: 540px; width: 700px; height: 450px;">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="queryInput" class="form-label mb-0 d-flex align-items-center gap-2">
                                    <span><i class="bi bi-code-slash"></i> Editor SQL</span>
                                    <span class="badge bg-info">PostgreSQL</span>
                                </label>
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('editor')" title="Minimizar">
                                        <i class="bi bi-dash-lg"></i>
                                    </button>
                                    <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="text-muted small"><i class="bi bi-lightning"></i> Cl√°usulas SQL</div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="restoreDefaultButtons()" title="Restaurar botones eliminados">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="showAddCustomButtonDialog()" title="A√±adir bot√≥n personalizado">
                                        <i class="bi bi-plus-circle"></i> A√±adir
                                    </button>
                                </div>
                            </div>
                            <div id="sqlButtonsContainer" class="d-flex flex-wrap gap-1">
                                <button class="btn btn-sm btn-outline-secondary sql-btn default-sql-btn" data-btn-id="select" onclick="insertAtCursor('SELECT ')">SELECT <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeDefaultButton(this, event)">√ó</span></button>
                                <button class="btn btn-sm btn-outline-secondary sql-btn default-sql-btn" data-btn-id="from" onclick="insertAtCursor('FROM ')">FROM <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeDefaultButton(this, event)">√ó</span></button>
                                <button class="btn btn-sm btn-outline-secondary sql-btn default-sql-btn" data-btn-id="where" onclick="insertAtCursor('WHERE ')">WHERE <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeDefaultButton(this, event)">√ó</span></button>
                                <button class="btn btn-sm btn-outline-secondary sql-btn default-sql-btn" data-btn-id="and" onclick="insertAtCursor('AND ')">AND <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeDefaultButton(this, event)">√ó</span></button>
                                <button class="btn btn-sm btn-outline-secondary sql-btn default-sql-btn" data-btn-id="or" onclick="insertAtCursor('OR ')">OR <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeDefaultButton(this, event)">√ó</span></button>
                                <button class="btn btn-sm btn-outline-secondary sql-btn default-sql-btn" data-btn-id="join" onclick="insertAtCursor('JOIN ')">JOIN <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeDefaultButton(this, event)">√ó</span></button>
                                <button class="btn btn-sm btn-outline-secondary sql-btn default-sql-btn" data-btn-id="count" onclick="insertAtCursor('COUNT(*)')">COUNT <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeDefaultButton(this, event)">√ó</span></button>
                                <button class="btn btn-sm btn-outline-secondary sql-btn default-sql-btn" data-btn-id="limit" onclick="insertAtCursor('LIMIT ')">LIMIT <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeDefaultButton(this, event)">√ó</span></button>
                            </div>
                        </div>
                        
                        <div class="position-relative flex-grow-1 mb-3">
                            <textarea class="form-control font-monospace h-100" id="queryInput" placeholder="Escribe tu consulta SQL aqu√≠...&#10;&#10;Ejemplo:&#10;SELECT * FROM products LIMIT 10;"></textarea>
                            <div id="autocompleteSuggestions" class="autocomplete-suggestions list-group"></div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success flex-grow-1" onclick="executeQuery()">
                                <i class="bi bi-play-fill"></i> Ejecutar
                            </button>
                            <button class="btn btn-secondary" onclick="clearQuery()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 4: Tablas Disponibles -->
            <div class="draggable-module" draggable="false" data-module-id="tablas" data-module-name="Tablas" data-module-icon="bi-table" style="left: 740px; top: 540px; width: 450px; height: 450px;">
                <div class="card shadow-sm h-100 d-flex flex-column">
                    <div class="card-body d-flex flex-column" style="min-height: 0;">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
                            <h5 class="card-title mb-0"><i class="bi bi-table"></i> Tablas Disponibles</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('tablas')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        <div class="flex-grow-1 overflow-auto" id="tablesContainer" style="min-height: 0;">
                            <div class="text-muted small p-3">
                                Cargando tablas...
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 5: Generador de Gr√°ficos -->
            <div class="draggable-module" draggable="false" data-module-id="graficos" data-module-name="Gr√°ficos" data-module-icon="bi-bar-chart-fill" style="left: 20px; top: 1010px; width: 600px; height: 500px;">
                <div class="card shadow-sm h-100 d-flex flex-column">
                    <div class="card-body d-flex flex-column" style="min-height: 0;">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
                            <h5 class="card-title mb-0"><i class="bi bi-bar-chart-fill"></i> Generador de Gr√°ficos</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('graficos')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <div id="chartConfigSection" class="d-none flex-shrink-0">
                            <div class="alert alert-info small mb-3">
                                <i class="bi bi-info-circle"></i> Ejecuta una consulta primero para generar gr√°ficos
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Tipo de Gr√°fico</label>
                                <select class="form-select form-select-sm" id="chartType">
                                    <option value="bar">Barras</option>
                                    <option value="line">L√≠neas</option>
                                    <option value="pie">Pastel</option>
                                    <option value="doughnut">Dona</option>
                                    <option value="radar">Radar</option>
                                    <option value="polarArea">√Årea Polar</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Eje X (Etiquetas)</label>
                                <select class="form-select form-select-sm" id="chartLabelColumn">
                                    <option value="">-- Selecciona columna --</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Eje Y (Valores)</label>
                                <select class="form-select form-select-sm" id="chartDataColumn">
                                    <option value="">-- Selecciona columna --</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small fw-bold">T√≠tulo del Gr√°fico</label>
                                <input type="text" class="form-control form-control-sm" id="chartTitle" placeholder="Mi Gr√°fico">
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm flex-grow-1" onclick="generateChart()">
                                    <i class="bi bi-graph-up"></i> Generar
                                </button>
                                <button class="btn btn-success btn-sm" onclick="showSaveChartModal()" id="saveChartBtn" disabled>
                                    <i class="bi bi-download"></i> Guardar
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="clearChart()">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="chartPlaceholder" class="text-center text-muted small p-5 flex-shrink-0">
                            <i class="bi bi-graph-up" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p class="mt-3">Ejecuta una consulta SQL para comenzar</p>
                        </div>
                        
                        <div id="chartContainer" class="flex-grow-1 d-none" style="position: relative; min-height: 0;">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 6: Conversor de Tipos de Datos -->
            <div class="draggable-module" draggable="false" data-module-id="conversor" data-module-name="Conversor" data-module-icon="bi-shuffle" style="left: 640px; top: 1010px; width: 500px; height: 450px;">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0"><i class="bi bi-shuffle"></i> Conversor de Tipos</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('conversor')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Columna a convertir</label>
                            <select class="form-select form-select-sm" id="columnToConvert" onchange="updateConversionPreview()">
                                <option value="">-- Selecciona una columna --</option>
                            </select>
                            <small class="text-muted">Columnas que aparecen en 2 o m√°s tablas</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Nombre de la nueva columna</label>
                            <input type="text" class="form-control form-control-sm" id="newColumnName" placeholder="Ej: price_numeric">
                            <small class="text-muted">La columna original se mantendr√° sin cambios</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Tipo de dato destino</label>
                            <select class="form-select form-select-sm" id="targetDataType">
                                <option value="NUMERIC">NUMERIC (decimales)</option>
                                <option value="INTEGER">INTEGER (enteros)</option>
                                <option value="DOUBLE PRECISION">DOUBLE PRECISION (decimales precisos)</option>
                            </select>
                        </div>
                        
                        <div id="conversionPreview" class="mb-3 d-none">
                            <label class="form-label small fw-bold">Vista previa de transformaci√≥n</label>
                            <div class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                                <div id="previewContent" class="small font-monospace"></div>
                            </div>
                        </div>
                        
                        <div id="affectedTables" class="mb-3">
                            <label class="form-label small fw-bold">Tablas afectadas: <span id="tablesCount" class="badge bg-secondary">0</span></label>
                            <div class="border rounded p-2" style="max-height: 120px; overflow-y: auto;">
                                <div id="tablesList" class="small">
                                    <span class="text-muted">Selecciona una columna primero</span>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-success w-100" id="convertButton" onclick="convertColumnType()" disabled>
                            <i class="bi bi-plus-circle"></i> Crear Columna Convertida
                        </button>
                        
                        <div id="conversionProgress" class="mt-3 d-none">
                            <div class="progress mb-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" id="conversionProgressBar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="conversionStatus">Procesando...</small>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 7: Galer√≠a de Gr√°ficos Guardados -->
            <div class="draggable-module" draggable="false" data-module-id="galeria-graficos" data-module-name="Galer√≠a Gr√°ficos" data-module-icon="bi-images" style="left: 1160px; top: 1010px; width: 450px; height: 450px;">
                <div class="card shadow-sm h-100 d-flex flex-column">
                    <div class="card-body d-flex flex-column" style="min-height: 0;">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
                            <h5 class="card-title mb-0"><i class="bi bi-images"></i> Gr√°ficos Guardados</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('galeria-graficos')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadSavedCharts()" title="Recargar">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <div class="alert alert-info small mb-3 flex-shrink-0">
                            <i class="bi bi-info-circle"></i> Gr√°ficos guardados en el servidor
                            <span id="chartsCount" class="badge bg-primary ms-2">0</span>
                        </div>
                        
                        <div id="savedChartsList" class="flex-grow-1 overflow-auto" style="min-height: 0;">
                            <div class="text-center text-muted p-4">
                                <i class="bi bi-image" style="font-size: 2rem; opacity: 0.3;"></i>
                                <p class="small mt-2">No hay gr√°ficos guardados</p>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 8: Personalizador Visual -->
            <div class="draggable-module" draggable="false" data-module-id="personalizador" data-module-name="Personalizar" data-module-icon="bi-palette" style="left: 20px; top: 1530px; width: 550px; height: 600px;">
                <div class="card shadow-sm h-100 d-flex flex-column">
                    <div class="card-body d-flex flex-column" style="min-height: 0;">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
                            <h5 class="card-title mb-0"><i class="bi bi-palette"></i> Personalizar Estilos</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('personalizador')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="resetStyles()" title="Restaurar defaults">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <div class="flex-grow-1 overflow-auto" style="min-height: 0;">
                            <!-- Paleta de Colores -->
                            <div class="mb-4">
                                <h6 class="text-muted mb-3"><i class="bi bi-paint-bucket"></i> Paleta de Colores</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Color Principal</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="color" class="form-control form-control-color" id="primaryColor" value="#667eea" onchange="applyPrimaryColor(this.value)">
                                        <input type="text" class="form-control form-control-sm font-monospace" id="primaryColorText" value="#667eea" style="max-width: 100px;">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Color Secundario</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="color" class="form-control form-control-color" id="secondaryColor" value="#764ba2" onchange="applySecondaryColor(this.value)">
                                        <input type="text" class="form-control form-control-sm font-monospace" id="secondaryColorText" value="#764ba2" style="max-width: 100px;">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Color de Fondo</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="color" class="form-control form-control-color" id="bgColor" value="#f8f9fa" onchange="applyBgColor(this.value)">
                                        <input type="text" class="form-control form-control-sm font-monospace" id="bgColorText" value="#f8f9fa" style="max-width: 100px;">
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Tipograf√≠a -->
                            <div class="mb-4">
                                <h6 class="text-muted mb-3"><i class="bi bi-fonts"></i> Tipograf√≠a</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Fuente Principal</label>
                                    <select class="form-select form-select-sm" id="mainFont" onchange="applyMainFont(this.value)">
                                        <option value="system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif" selected>Sistema (Default)</option>
                                        <option value="'Arial', sans-serif">Arial</option>
                                        <option value="'Helvetica', sans-serif">Helvetica</option>
                                        <option value="'Georgia', serif">Georgia</option>
                                        <option value="'Times New Roman', serif">Times New Roman</option>
                                        <option value="'Courier New', monospace">Courier New</option>
                                        <option value="'Verdana', sans-serif">Verdana</option>
                                        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                                        <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                                        <option value="'Impact', fantasy">Impact</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Tama√±o de Texto</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="range" class="form-range" id="fontSize" min="12" max="20" value="16" step="1" onchange="applyFontSize(this.value)">
                                        <span class="badge bg-secondary" id="fontSizeValue">16px</span>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Colores de Texto -->
                            <div class="mb-4">
                                <h6 class="text-muted mb-3"><i class="bi bi-type"></i> Colores de Texto</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Color de T√≠tulos</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="color" class="form-control form-control-color" id="headingColor" value="#212529" onchange="applyHeadingColor(this.value)">
                                        <input type="text" class="form-control form-control-sm font-monospace" id="headingColorText" value="#212529" style="max-width: 100px;">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Color de Texto Normal</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="color" class="form-control form-control-color" id="textColor" value="#212529" onchange="applyTextColor(this.value)">
                                        <input type="text" class="form-control form-control-sm font-monospace" id="textColorText" value="#212529" style="max-width: 100px;">
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Estilo de M√≥dulos -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-3"><i class="bi bi-grid-3x3"></i> Estilo de M√≥dulos</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Borde de Tarjetas</label>
                                    <select class="form-select form-select-sm" id="cardBorder" onchange="applyCardBorder(this.value)">
                                        <option value="none" selected>Sin borde</option>
                                        <option value="1px solid #dee2e6">Fino</option>
                                        <option value="2px solid #dee2e6">Medio</option>
                                        <option value="3px solid #667eea">Grueso (Color principal)</option>
                                        <option value="custom">Personalizado</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Color de Borde de Tarjetas</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="color" class="form-control form-control-color" id="cardBorderColor" value="#dee2e6" onchange="applyCardBorderColor(this.value)">
                                        <input type="text" class="form-control form-control-sm font-monospace" id="cardBorderColorText" value="#dee2e6" style="max-width: 100px;">
                                    </div>
                                    <small class="text-muted">Para bordes personalizados, selecciona "Personalizado" arriba</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Grosor de Borde</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="range" class="form-range" id="borderWidth" min="0" max="5" value="1" step="1" onchange="applyBorderWidth(this.value)">
                                        <span class="badge bg-secondary" id="borderWidthValue">1px</span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Radio de Bordes</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="range" class="form-range" id="borderRadius" min="0" max="20" value="6" step="2" onchange="applyBorderRadius(this.value)">
                                        <span class="badge bg-secondary" id="borderRadiusValue">6px</span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Color de Fondo de Tarjetas</label>
                                    <div class="d-flex gap-2 align-items-center">
                                        <input type="color" class="form-control form-control-color" id="cardBgColor" value="#ffffff" onchange="applyCardBgColor(this.value)">
                                        <input type="text" class="form-control form-control-sm font-monospace" id="cardBgColorText" value="#ffffff" style="max-width: 100px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 d-flex gap-2 flex-shrink-0">
                            <button class="btn btn-success flex-grow-1" onclick="saveCustomStyles()">
                                <i class="bi bi-save"></i> Guardar Tema
                            </button>
                            <button class="btn btn-outline-primary" onclick="exportStyles()">
                                <i class="bi bi-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 9: Galer√≠a de Im√°genes -->
            <div class="draggable-module" draggable="false" data-module-id="galeria-imagenes" data-module-name="Galer√≠a Im√°genes" data-module-icon="bi-card-image" style="left: 590px; top: 1530px; width: 600px; height: 600px;">
                <div class="card shadow-sm h-100 d-flex flex-column">
                    <div class="card-body d-flex flex-column" style="min-height: 0;">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
                            <h5 class="card-title mb-0"><i class="bi bi-images"></i> Galer√≠a de Im√°genes</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('galeria-imagenes')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <!-- Controles de vista -->
                        <div class="mb-3 d-flex gap-2 align-items-center flex-shrink-0">
                            <label class="form-label small mb-0 fw-semibold">Tama√±o:</label>
                            <select class="form-select form-select-sm" id="imageSize" onchange="updateImageSize(this.value)" style="max-width: 150px;">
                                <option value="100">Peque√±o</option>
                                <option value="150" selected>Mediano</option>
                                <option value="200">Grande</option>
                                <option value="250">Muy Grande</option>
                            </select>
                            <span class="badge bg-info" id="imageCount">0 im√°genes</span>
                        </div>
                        
                        <!-- Contenedor de im√°genes con scroll -->
                        <div class="flex-grow-1 overflow-auto" style="min-height: 0;">
                            <div id="imageGallery" class="row row-cols-auto g-2">
                                <div class="col-12 text-center text-muted p-4">
                                    <i class="bi bi-images" style="font-size: 3rem; opacity: 0.3;"></i>
                                    <p class="mt-2">Las im√°genes aparecer√°n aqu√≠ cuando ejecutes una consulta SQL que contenga URLs de im√°genes</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 10: Visualizador de Im√°genes (Canvas) -->
            <div class="draggable-module" draggable="false" data-module-id="visualizador" data-module-name="Visualizador" data-module-icon="bi-easel" style="left: 600px; top: 1530px; width: 800px; height: 600px;">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column p-0">
                        <div class="d-flex justify-content-between align-items-center mb-0 p-3 border-bottom">
                            <h5 class="card-title mb-0"><i class="bi bi-easel"></i> Visualizador de Im√°genes</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-danger" onclick="clearImageBoard()" title="Limpiar todo">
                                    <i class="bi bi-trash"></i> Limpiar
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('visualizador')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <!-- Canvas interno para im√°genes -->
                        <div id="imageBoard" class="flex-grow-1 position-relative" style="overflow: hidden; background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%, transparent 75%, #f8f9fa 75%, #f8f9fa), linear-gradient(45deg, #f8f9fa 25%, transparent 25%, transparent 75%, #f8f9fa 75%, #f8f9fa); background-size: 20px 20px; background-position: 0 0, 10px 10px;">
                            <div class="position-absolute top-50 start-50 translate-middle text-center text-muted" id="imageBoardPlaceholder">
                                <i class="bi bi-images" style="font-size: 4rem; opacity: 0.2;"></i>
                                <p class="mt-3">Haz clic en una imagen de "Gr√°ficos Guardados"<br>para agregarla al visualizador</p>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 11: Resultados SQL -->
            <div class="draggable-module" draggable="false" data-module-id="resultados" data-module-name="Resultados SQL" data-module-icon="bi-table" style="left: 1420px; top: 30px; width: 900px; height: 650px;">
                <div class="card shadow-sm h-100 d-flex flex-column">
                    <div class="card-body d-flex flex-column p-0" style="min-height: 0;">
                        <div class="d-flex justify-content-between align-items-center mb-0 p-3 border-bottom flex-shrink-0">
                            <h5 class="card-title mb-0"><i class="bi bi-table"></i> Resultados SQL</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('resultados')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <!-- Contenedor de resultados con scroll -->
                        <div class="flex-grow-1 p-3 overflow-auto" style="min-height: 0;">
                            <div id="results">
                                <div class="text-center text-muted p-5">
                                    <i class="bi bi-play-circle" style="font-size: 4rem; opacity: 0.2;"></i>
                                    <p class="mt-3">Ejecuta una consulta SQL para ver los resultados aqu√≠</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            <!-- M√≥dulo 12: Control de Canvas -->
            <div class="draggable-module" draggable="false" data-module-id="canvas-control" data-module-name="Control Canvas" data-module-icon="bi-arrows-fullscreen" style="left: 30px; top: 1530px; width: 500px; height: 180px;">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0"><i class="bi bi-arrows-fullscreen"></i> Tama√±o del Canvas</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="minimizeModule('canvas-control')" title="Minimizar">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        
                        <!-- Control del slider -->
                        <div class="flex-grow-1 d-flex flex-column justify-content-center">
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <span class="text-muted small" style="min-width: 50px;">M√≠nimo</span>
                                <input type="range" class="form-range" id="canvasSizeSlider" 
                                       min="800" max="2000" step="100" value="1200"
                                       style="flex: 1;">
                                <span class="text-muted small" style="min-width: 50px; text-align: right;">M√°ximo</span>
                            </div>
                            <div class="text-center">
                                <span class="badge bg-primary fs-6" id="canvasSizeLabel">1200 x 1200</span>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Resize handles -->
                <div class="resize-handle resize-right"></div>
                <div class="resize-handle resize-bottom"></div>
                <div class="resize-handle resize-corner"></div>
            </div>
            
            </div><!-- fin modulesGrid -->
        </div><!-- fin workspaceCanvas -->
    </div>
    
    <!-- Barra de herramientas flotante para m√≥dulos minimizados -->
    <div id="minimizedToolbar" class="minimized-toolbar">
        <div class="toolbar-content">
            <div class="toolbar-title">
                <i class="bi bi-grid-3x3-gap"></i>
                <span>Mods</span>
            </div>
            <div id="minimizedModulesList" class="minimized-modules-list">
                <!-- Los m√≥dulos minimizados aparecer√°n aqu√≠ -->
            </div>
        </div>
    </div>
    
    <!-- Men√∫ contextual para m√≥dulos -->
    <div id="moduleContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item" onclick="duplicateModule()">
            <i class="bi bi-files"></i> Duplicar m√≥dulo
        </div>
    </div>
    
    <script>
        // Variables globales para autocompletado
        let allTables = [];
        let allColumns = {};
        let sqlKeywords = [
            'SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'NOT', 'IN', 'LIKE', 'BETWEEN',
            'GROUP BY', 'HAVING', 'ORDER BY', 'ASC', 'DESC', 'LIMIT', 'OFFSET',
            'JOIN', 'INNER JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'FULL JOIN', 'ON',
            'COUNT', 'SUM', 'AVG', 'MAX', 'MIN', 'DISTINCT', 'AS',
            'INSERT INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE FROM',
            'CREATE TABLE', 'DROP TABLE', 'ALTER TABLE',
            'IS NULL', 'IS NOT NULL', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END'
        ];
        
        // Cargar tablas al inicio
        window.addEventListener('DOMContentLoaded', () => {
            loadTables();
            loadColumnsFilter();
            loadCommonColumnsForConversion();
            setupAutocomplete();
            initializeDragAndDrop();
            loadCustomSQLButtons(); // Cargar botones SQL personalizados
            loadHiddenDefaultButtons(); // Cargar botones SQL ocultos
        });
        
        // ========== DRAG AND DROP CON POSICIONAMIENTO LIBRE ==========
        let draggedElement = null;
        let isDragging = false;
        let dragStartX, dragStartY;
        let offsetX, offsetY;
        
        function initializeDragAndDrop() {
            const draggableModules = document.querySelectorAll('.draggable-module');
            
            draggableModules.forEach(module => {
                const dragHandle = module.querySelector('.drag-handle');
                if (dragHandle) {
                    dragHandle.addEventListener('mousedown', (e) => startDrag(e, module));
                }
            });
            
            // Event listeners globales
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', stopDrag);
            
            // Prevenir que los controles interactivos interfieran
            const interactiveElements = document.querySelectorAll('input[type="range"], input[type="color"], input[type="text"], select, textarea, button:not(.drag-handle)');
            interactiveElements.forEach(element => {
                element.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
            });
        }
        
        function startDrag(e, module) {
            // Prevenir comportamiento por defecto
            e.preventDefault();
            e.stopPropagation();
            
            isDragging = true;
            draggedElement = module;
            
            // Agregar clase de arrastre
            module.classList.add('dragging');
            document.body.classList.add('dragging-active');
            
            // Calcular offset del mouse respecto al m√≥dulo
            const rect = module.getBoundingClientRect();
            const gridRect = document.getElementById('modulesGrid').getBoundingClientRect();
            
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            // Aumentar z-index del elemento arrastrado
            module.style.zIndex = '1000';
            
            // Cambiar cursor
            document.body.style.cursor = 'grabbing';
        }
        
        function onDragMove(e) {
            if (!isDragging || !draggedElement) return;
            
            e.preventDefault();
            
            const gridRect = document.getElementById('modulesGrid').getBoundingClientRect();
            
            // Calcular nueva posici√≥n (relativa al grid)
            let newX = e.clientX - gridRect.left - offsetX;
            let newY = e.clientY - gridRect.top - offsetY;
            
            // L√≠mites para que no se salga del contenedor
            newX = Math.max(0, Math.min(newX, gridRect.width - draggedElement.offsetWidth));
            newY = Math.max(0, newY);
            
            // Actualizar posici√≥n
            draggedElement.style.left = newX + 'px';
            draggedElement.style.top = newY + 'px';
        }
        
        function stopDrag(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            
            // Remover clase de arrastre
            draggedElement.classList.remove('dragging');
            document.body.classList.remove('dragging-active');
            
            // Restaurar z-index
            draggedElement.style.zIndex = '1';
            
            // Restaurar cursor
            document.body.style.cursor = '';
            
            // Guardar posici√≥n en localStorage
            saveModulePosition(draggedElement);
            
            isDragging = false;
            draggedElement = null;
        }
        
        function saveModulePosition(module) {
            const moduleId = module.dataset.moduleId;
            const positions = JSON.parse(localStorage.getItem('modulePositions') || '{}');
            
            positions[moduleId] = {
                left: module.style.left,
                top: module.style.top,
                width: module.style.width,
                height: module.style.height
            };
            
            localStorage.setItem('modulePositions', JSON.stringify(positions));
        }
        
        function loadModulePositions() {
            const positions = JSON.parse(localStorage.getItem('modulePositions') || '{}');
            
            document.querySelectorAll('.draggable-module').forEach(module => {
                const moduleId = module.dataset.moduleId;
                if (positions[moduleId]) {
                    const pos = positions[moduleId];
                    if (pos.left) module.style.left = pos.left;
                    if (pos.top) module.style.top = pos.top;
                    if (pos.width) module.style.width = pos.width;
                    if (pos.height) module.style.height = pos.height;
                }
            });
        }
        
        // Cargar posiciones guardadas al inicio
        setTimeout(() => {
            loadModulePositions();
        }, 100);
        // ========== FIN DRAG AND DROP ==========
        
        // ========== RESIZE FUNCTIONALITY ==========
        let isResizing = false;
        let currentResizeElement = null;
        let resizeType = null;
        let startX, startY, startWidth, startHeight;
        
        function initializeResize() {
            document.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('resize-right')) {
                    isResizing = true;
                    resizeType = 'width';
                    currentResizeElement = e.target.parentElement;
                    startX = e.clientX;
                    startWidth = parseInt(getComputedStyle(currentResizeElement).width);
                    e.preventDefault();
                } else if (e.target.classList.contains('resize-bottom')) {
                    isResizing = true;
                    resizeType = 'height';
                    currentResizeElement = e.target.parentElement;
                    startY = e.clientY;
                    startHeight = parseInt(getComputedStyle(currentResizeElement).height);
                    e.preventDefault();
                } else if (e.target.classList.contains('resize-corner')) {
                    isResizing = true;
                    resizeType = 'both';
                    currentResizeElement = e.target.parentElement;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = parseInt(getComputedStyle(currentResizeElement).width);
                    startHeight = parseInt(getComputedStyle(currentResizeElement).height);
                    e.preventDefault();
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                if (resizeType === 'width' || resizeType === 'both') {
                    const width = startWidth + (e.clientX - startX);
                    if (width >= 300) {
                        currentResizeElement.style.width = width + 'px';
                    }
                }
                
                if (resizeType === 'height' || resizeType === 'both') {
                    const height = startHeight + (e.clientY - startY);
                    if (height >= 250) {
                        currentResizeElement.style.height = height + 'px';
                    }
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    if (currentResizeElement) {
                        saveModulePosition(currentResizeElement);
                        currentResizeElement = null;
                    }
                }
            });
        }
        
        // Inicializar resize
        setTimeout(() => {
            initializeResize();
        }, 150);
        // ========== FIN RESIZE ==========
        
        // ========== DRAG DE IM√ÅGENES AL CANVAS ==========
        let draggedImage = null;
        let imageModuleCounter = 0;
        
        function handleImageDragStart(e) {
            draggedImage = {
                url: this.dataset.imageUrl,
                filename: this.dataset.imageFilename,
                index: this.dataset.imageIndex
            };
            
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', 'image-module');
        }
        
        function handleImageDragEnd(e) {
            this.classList.remove('dragging');
        }
        
        function initializeCanvasDrop() {
            const canvas = document.getElementById('workspaceCanvas');
            const modulesGrid = document.getElementById('modulesGrid');
            
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });
            
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                
                if (draggedImage) {
                    // Obtener posici√≥n relativa al grid
                    const canvasRect = canvas.getBoundingClientRect();
                    const gridRect = modulesGrid.getBoundingClientRect();
                    
                    const scrollLeft = canvas.scrollLeft;
                    const scrollTop = canvas.scrollTop;
                    
                    const x = e.clientX - canvasRect.left + scrollLeft;
                    const y = e.clientY - canvasRect.top + scrollTop;
                    
                    // Crear m√≥dulo de imagen en el canvas
                    createImageModule(draggedImage.url, draggedImage.filename, x, y);
                    
                    draggedImage = null;
                }
            });
        }
        
        function createImageModule(imageUrl, filename, x, y) {
            imageModuleCounter++;
            const moduleId = `image-${imageModuleCounter}`;
            
            const imageModule = document.createElement('div');
            imageModule.className = 'draggable-module resizable';
            imageModule.draggable = false;
            imageModule.dataset.moduleId = moduleId;
            imageModule.dataset.moduleName = filename;
            imageModule.dataset.moduleIcon = 'bi-image';
            imageModule.style.cssText = `left: ${x}px; top: ${y}px; width: 400px; height: 350px;`;
            
            imageModule.innerHTML = `
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column p-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="card-title mb-0 small text-truncate" title="${filename}">
                                <i class="bi bi-image"></i> ${filename.substring(0, 30)}...
                            </h6>
                            <div class="d-flex gap-1 align-items-center">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeImageModule('${moduleId}')" title="Eliminar">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                                <span class="drag-handle" title="Arrastra para mover"><i class="bi bi-grip-vertical"></i></span>
                            </div>
                        </div>
                        <div class="flex-grow-1 d-flex align-items-center justify-content-center bg-light rounded">
                            <img src="${imageUrl}" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar al grid
            document.getElementById('modulesGrid').appendChild(imageModule);
            
            // Inicializar drag para este m√≥dulo
            const dragHandle = imageModule.querySelector('.drag-handle');
            if (dragHandle) {
                dragHandle.addEventListener('mousedown', () => {
                    imageModule.draggable = true;
                });
                dragHandle.addEventListener('mouseup', () => {
                    imageModule.draggable = false;
                });
            }
            
            imageModule.addEventListener('dragstart', handleDragStart);
            imageModule.addEventListener('dragend', handleDragEnd);
            
            // Inicializar resize para este m√≥dulo
            const resizeHandles = imageModule.querySelectorAll('.resize-handle');
            resizeHandles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
            });
            
            // Prevenir drag en elementos interactivos
            const interactiveElements = imageModule.querySelectorAll('button, img');
            interactiveElements.forEach(element => {
                element.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    imageModule.draggable = false;
                });
            });
            
            console.log(`‚úÖ M√≥dulo de imagen creado: ${moduleId} en (${x}, ${y})`);
        }
        
        function removeImageModule(moduleId) {
            const module = document.querySelector(`[data-module-id="${moduleId}"]`);
            if (module) {
                module.remove();
                console.log(`üóëÔ∏è M√≥dulo de imagen eliminado: ${moduleId}`);
            }
        }
        
        // Inicializar drop en canvas
        setTimeout(() => {
            initializeCanvasDrop();
        }, 200);
        // ========== FIN DRAG DE IM√ÅGENES AL CANVAS ==========
        
        // ========== FILTRO DE COLUMNAS ==========
        let columnsByTable = {};
        let selectedTables = new Set();
        
        // Evitar que el dropdown se cierre al hacer click dentro
        document.addEventListener('DOMContentLoaded', () => {
            const dropdownMenu = document.querySelector('#tableFilterDropdown + .dropdown-menu');
            if (dropdownMenu) {
                dropdownMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        });
        
        async function loadColumnsFilter() {
            try {
                const response = await fetch('/columns-by-table');
                const result = await response.json();
                
                if (result.success) {
                    columnsByTable = result.data;
                    renderTableFilterList();
                    // Seleccionar todas las tablas por defecto
                    selectAllTables();
                }
            } catch (error) {
                console.error('Error loading columns filter:', error);
            }
        }
        
        function renderTableFilterList() {
            const container = document.getElementById('tableFilterList');
            const tables = Object.keys(columnsByTable).sort();
            
            let html = '';
            tables.forEach(table => {
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${table}" id="filter-${table}" 
                               onchange="updateTableFilter()" checked>
                        <label class="form-check-label small" for="filter-${table}">
                            ${table}
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function selectAllTables() {
            const checkboxes = document.querySelectorAll('#tableFilterList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateTableFilter();
        }
        
        function clearAllTables() {
            const checkboxes = document.querySelectorAll('#tableFilterList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateTableFilter();
        }
        
        function updateTableFilter() {
            // Obtener tablas seleccionadas
            const checkboxes = document.querySelectorAll('#tableFilterList input[type="checkbox"]:checked');
            selectedTables = new Set(Array.from(checkboxes).map(cb => cb.value));
            
            // Actualizar contador
            const count = selectedTables.size;
            const totalTables = Object.keys(columnsByTable).length;
            const countSpan = document.getElementById('selectedTablesCount');
            
            if (count === 0) {
                countSpan.textContent = 'Ninguna';
            } else if (count === totalTables) {
                countSpan.textContent = 'Todas';
            } else {
                countSpan.textContent = count;
            }
            
            // Filtrar y mostrar columnas
            filterAndDisplayColumns();
        }
        
        function filterAndDisplayColumns() {
            const container = document.getElementById('columnsListContainer');
            
            if (selectedTables.size === 0) {
                container.innerHTML = '<div class="text-muted small p-3">Selecciona al menos una tabla para ver sus columnas</div>';
                return;
            }
            
            // Obtener columnas √∫nicas de las tablas seleccionadas
            const columnFrequency = {};
            
            selectedTables.forEach(table => {
                const columns = columnsByTable[table] || [];
                columns.forEach(col => {
                    if (!columnFrequency[col]) {
                        columnFrequency[col] = 0;
                    }
                    columnFrequency[col]++;
                });
            });
            
            // Convertir a array y ordenar por frecuencia
            const sortedColumns = Object.entries(columnFrequency)
                .sort((a, b) => {
                    // Ordenar por frecuencia descendente, luego por nombre
                    if (b[1] !== a[1]) return b[1] - a[1];
                    return a[0].localeCompare(b[0]);
                });
            
            // Renderizar columnas
            let html = '';
            sortedColumns.forEach(([column, frequency]) => {
                html += `
                    <div class="list-group-item list-group-item-action clickable border-start border-3 border-primary mb-2" onclick="insertAtCursor('${column}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-primary">${column}</span>
                            <span class="badge bg-light text-dark">${frequency} ${frequency === 1 ? 'tabla' : 'tablas'}</span>
                        </div>
                    </div>
                `;
            });
            
            if (sortedColumns.length === 0) {
                html = '<div class="text-muted small p-3">No hay columnas en las tablas seleccionadas</div>';
            }
            
            container.innerHTML = html;
        }
        // ========== FIN FILTRO DE COLUMNAS ==========
        
        async function loadTables() {
            const container = document.getElementById('tablesContainer');
            
            try {
                const response = await fetch('/tables');
                const result = await response.json();
                
                if (result.success && result.data) {
                    let html = '';
                    
                    // Guardar nombres de tablas para autocompletado
                    allTables = result.data.map(row => row.table_name);
                    
                    for (const row of result.data) {
                        const tableName = row.table_name;
                        const rowCount = row.row_count || 0;
                        html += `
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 border rounded bg-light">
                                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                                        <span class="clickable fw-bold" onclick="insertTableQuery('${tableName}')" title="Click para insertar">
                                            <i class="bi bi-table"></i> ${tableName}
                                        </span>
                                        <span class="badge bg-secondary">${rowCount} filas</span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${tableName}" aria-expanded="false">
                                        <i class="bi bi-info-circle"></i> info
                                    </button>
                                </div>
                                <div class="collapse mt-1" id="collapse-${tableName}">
                                    <div class="card card-body p-2 small">
                                        <div id="schema-${tableName}">
                                            <div class="text-muted small">Cargando esquema...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                    
                    // Precargar esquemas
                    for (const row of result.data) {
                        loadSchema(row.table_name);
                    }
                } else {
                    container.innerHTML = '<div class="text-muted small p-3">No hay tablas</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger small">${error.message}</div>`;
            }
        }
        
        async function loadSchema(tableName) {
            try {
                const response = await fetch(`/schema/${tableName}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const schemaDiv = document.getElementById(`schema-${tableName}`);
                    let html = '<div class="row row-cols-2 g-1">';
                    
                    for (const col of result.data) {
                        html += `
                            <div class="col">
                                <div class="d-flex justify-content-between align-items-center p-1 border-bottom">
                                    <span class="text-primary fw-bold" style="font-size: 11px;">${col.column_name}</span>
                                    <span class="text-muted" style="font-size: 10px;">${col.data_type}</span>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    schemaDiv.innerHTML = html;
                    
                    // Guardar columnas para autocompletado
                    allColumns[tableName] = result.data.map(col => col.column_name);
                }
            } catch (error) {
                console.error('Error loading schema:', error);
            }
        }
        
        function setupAutocomplete() {
            const queryInput = document.getElementById('queryInput');
            const suggestionsDiv = document.getElementById('autocompleteSuggestions');
            let selectedIndex = -1;
            
            queryInput.addEventListener('input', function(e) {
                const cursorPos = this.selectionStart;
                const textBeforeCursor = this.value.substring(0, cursorPos);
                const lastWord = textBeforeCursor.split(/\s+/).pop().toUpperCase();
                
                if (lastWord.length < 2) {
                    suggestionsDiv.classList.remove('active');
                    return;
                }
                
                // Buscar coincidencias
                let suggestions = [];
                
                // Keywords SQL
                sqlKeywords.forEach(keyword => {
                    if (keyword.startsWith(lastWord)) {
                        suggestions.push({ text: keyword, type: 'keyword' });
                    }
                });
                
                // Tablas
                allTables.forEach(table => {
                    if (table.toUpperCase().includes(lastWord)) {
                        suggestions.push({ text: table, type: 'table' });
                    }
                });
                
                // Columnas
                Object.values(allColumns).flat().forEach(column => {
                    if (column.toUpperCase().includes(lastWord) && !suggestions.find(s => s.text === column)) {
                        suggestions.push({ text: column, type: 'column' });
                    }
                });
                
                if (suggestions.length > 0) {
                    showSuggestions(suggestions, lastWord);
                    selectedIndex = -1;
                } else {
                    suggestionsDiv.classList.remove('active');
                }
            });
            
            queryInput.addEventListener('keydown', function(e) {
                const items = suggestionsDiv.querySelectorAll('.autocomplete-item');
                
                if (!suggestionsDiv.classList.contains('active')) return;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = (selectedIndex + 1) % items.length;
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
                    updateSelection(items);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    items[selectedIndex].click();
                } else if (e.key === 'Escape') {
                    suggestionsDiv.classList.remove('active');
                }
            });
            
            // Cerrar al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!queryInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.remove('active');
                }
            });
        }
        
        function showSuggestions(suggestions, searchTerm) {
            const suggestionsDiv = document.getElementById('autocompleteSuggestions');
            const queryInput = document.getElementById('queryInput');
            
            // Limitar a 10 sugerencias
            suggestions = suggestions.slice(0, 10);
            
            let html = '';
            suggestions.forEach((suggestion, index) => {
                html += `
                    <button type="button" class="list-group-item list-group-item-action autocomplete-item d-flex justify-content-between align-items-center" onclick="acceptSuggestion('${suggestion.text.replace(/'/g, "\\'")}', '${searchTerm}')">
                        <span class="font-monospace">${suggestion.text}</span>
                        <span class="badge bg-${suggestion.type === 'keyword' ? 'primary' : suggestion.type === 'table' ? 'success' : 'secondary'}">${suggestion.type}</span>
                    </button>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.classList.add('show');
            
            // Posicionar el div de sugerencias
            const rect = queryInput.getBoundingClientRect();
            suggestionsDiv.style.top = (rect.bottom - rect.top) + 'px';
            suggestionsDiv.style.left = '15px';
        }
        
        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        function acceptSuggestion(suggestion, searchTerm) {
            const queryInput = document.getElementById('queryInput');
            const cursorPos = queryInput.selectionStart;
            const textBeforeCursor = queryInput.value.substring(0, cursorPos);
            const textAfterCursor = queryInput.value.substring(cursorPos);
            
            // Reemplazar la √∫ltima palabra con la sugerencia
            const words = textBeforeCursor.split(/\s+/);
            words.pop(); // Quitar √∫ltima palabra
            const newTextBefore = words.join(' ') + (words.length > 0 ? ' ' : '') + suggestion + ' ';
            
            queryInput.value = newTextBefore + textAfterCursor;
            queryInput.selectionStart = queryInput.selectionEnd = newTextBefore.length;
            queryInput.focus();
            
            document.getElementById('autocompleteSuggestions').classList.remove('show');
        }
        
        function insertTableQuery(tableName) {
            insertAtCursor(tableName);
        }
        
        function insertAtCursor(text) {
            const queryInput = document.getElementById('queryInput');
            const startPos = queryInput.selectionStart;
            const endPos = queryInput.selectionEnd;
            const currentValue = queryInput.value;
            
            // Insertar texto en la posici√≥n del cursor
            const newValue = currentValue.substring(0, startPos) + text + currentValue.substring(endPos);
            queryInput.value = newValue;
            
            // Posicionar cursor despu√©s del texto insertado
            // Para funciones con par√©ntesis, posicionar dentro
            let cursorPosition = startPos + text.length;
            if (text.includes('()') && !text.includes('COUNT(*)')) {
                cursorPosition = startPos + text.indexOf('()') + 1;
            } else if (text.includes('\'%%\'')) {
                cursorPosition = startPos + text.indexOf('%%');
            } else if (text.includes('CASE WHEN')) {
                cursorPosition = startPos + 10; // Despu√©s de "CASE WHEN "
            }
            
            queryInput.focus();
            queryInput.setSelectionRange(cursorPosition, cursorPosition);
            
            // Efecto visual
            queryInput.style.background = '#fff3cd';
            setTimeout(() => {
                queryInput.style.background = '#f5f5f5';
            }, 200);
        }
        
        // ========== BOTONES SQL PERSONALIZADOS ==========
        function loadCustomSQLButtons() {
            const saved = localStorage.getItem('customSQLButtons');
            if (saved) {
                const buttons = JSON.parse(saved);
                buttons.forEach(btn => addCustomButtonToDOM(btn.label, btn.sql, false));
            }
        }
        
        function saveCustomSQLButtons() {
            const container = document.getElementById('sqlButtonsContainer');
            const customButtons = [];
            
            container.querySelectorAll('.custom-sql-btn').forEach(btn => {
                const label = btn.textContent.trim().replace('√ó', '').trim();
                const sql = btn.getAttribute('data-sql');
                customButtons.push({ label, sql });
            });
            
            localStorage.setItem('customSQLButtons', JSON.stringify(customButtons));
        }
        
        function showAddCustomButtonDialog() {
            const label = prompt('Etiqueta del bot√≥n (ej: "TOP 10", "INNER JOIN"):');
            if (!label) return;
            
            const sql = prompt('C√≥digo SQL a insertar (ej: "LIMIT 10", "INNER JOIN tabla ON "):');
            if (!sql) return;
            
            addCustomButtonToDOM(label, sql, true);
        }
        
        function addCustomButtonToDOM(label, sql, save = true) {
            const container = document.getElementById('sqlButtonsContainer');
            
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-outline-primary sql-btn custom-sql-btn';
            btn.setAttribute('data-sql', sql);
            btn.innerHTML = `${label} <span class="text-danger" style="font-size: 0.7em; cursor: pointer;" onclick="removeCustomButton(this, event)">√ó</span>`;
            btn.onclick = function(e) {
                if (!e.target.classList.contains('text-danger')) {
                    insertAtCursor(sql);
                }
            };
            
            container.appendChild(btn);
            
            if (save) {
                saveCustomSQLButtons();
            }
        }
        
        function removeCustomButton(element, event) {
            event.stopPropagation();
            if (confirm('¬øEliminar este bot√≥n personalizado?')) {
                element.closest('.custom-sql-btn').remove();
                saveCustomSQLButtons();
            }
        }
        
        function removeDefaultButton(element, event) {
            event.stopPropagation();
            const button = element.closest('.default-sql-btn');
            const btnId = button.getAttribute('data-btn-id');
            
            if (confirm('¬øOcultar este bot√≥n? (Puedes restaurarlo con el bot√≥n ‚ü≤)')) {
                button.style.display = 'none';
                saveHiddenDefaultButtons(btnId);
            }
        }
        
        function saveHiddenDefaultButtons(btnId) {
            let hiddenButtons = JSON.parse(localStorage.getItem('hiddenSQLButtons') || '[]');
            if (!hiddenButtons.includes(btnId)) {
                hiddenButtons.push(btnId);
                localStorage.setItem('hiddenSQLButtons', JSON.stringify(hiddenButtons));
            }
        }
        
        function loadHiddenDefaultButtons() {
            const hiddenButtons = JSON.parse(localStorage.getItem('hiddenSQLButtons') || '[]');
            hiddenButtons.forEach(btnId => {
                const button = document.querySelector(`.default-sql-btn[data-btn-id="${btnId}"]`);
                if (button) {
                    button.style.display = 'none';
                }
            });
        }
        
        function restoreDefaultButtons() {
            const buttons = document.querySelectorAll('.default-sql-btn');
            buttons.forEach(btn => btn.style.display = '');
            localStorage.removeItem('hiddenSQLButtons');
            
            // Mostrar mensaje de confirmaci√≥n
            const container = document.getElementById('sqlButtonsContainer');
            const msg = document.createElement('div');
            msg.className = 'alert alert-success py-1 px-2 m-0';
            msg.style.fontSize = '0.75rem';
            msg.textContent = '‚úì Botones restaurados';
            container.parentElement.appendChild(msg);
            setTimeout(() => msg.remove(), 2000);
        }
        
        function showColumnInfo(columnName, frequency) {
            const queryInput = document.getElementById('queryInput');
            
            // Generar query que muestre la columna en todas las tablas que la tienen
            const query = `-- Columna "${columnName}" aparece en ${frequency} tabla(s)
-- Puedes modificar esta consulta seg√∫n tus necesidades

SELECT ${columnName}
FROM (
    SELECT table_name 
    FROM information_schema.columns 
    WHERE column_name = '${columnName}' 
    AND table_schema = 'public'
    LIMIT 1
) t;

-- Ejemplo: Ver valores √∫nicos de esta columna
-- SELECT DISTINCT ${columnName} FROM [nombre_tabla];

-- Ejemplo: Contar valores
-- SELECT ${columnName}, COUNT(*) FROM [nombre_tabla] GROUP BY ${columnName};`;
            
            queryInput.value = query;
            queryInput.focus();
            
            // Efecto visual
            queryInput.style.background = '#e3f2fd';
            setTimeout(() => {
                queryInput.style.background = '#f5f5f5';
            }, 300);
        }
        
        function loadQuery(query) {
            document.getElementById('queryInput').value = query.trim();
        }
        
        async function startScraping() {
            const platform = document.getElementById('platformSelect').value;
            const searchTerm = document.getElementById('searchTermInput').value.trim();
            const numProducts = parseInt(document.getElementById('numProductsInput').value) || 50;
            const statusDiv = document.getElementById('scraperStatus');
            const scrapeBtn = document.getElementById('scrapeBtn');
            const progressContainer = document.getElementById('progressContainer');
            const reloadBtn = document.getElementById('reloadBtn');
            
            if (!searchTerm) {
                statusDiv.className = 'alert alert-danger mt-3';
                statusDiv.textContent = '‚ö†Ô∏è Por favor ingresa un t√©rmino de b√∫squeda';
                return;
            }
            
            // Validar n√∫mero
            if (numProducts < 1) {
                statusDiv.className = 'alert alert-danger mt-3';
                statusDiv.textContent = '‚ö†Ô∏è El n√∫mero de productos debe ser mayor a 0';
                return;
            }
            
            // Resetear interfaz
            progressContainer.classList.remove('d-none');
            statusDiv.className = 'd-none';
            reloadBtn.classList.add('d-none');
            scrapeBtn.disabled = true;
            scrapeBtn.textContent = '‚è≥ Scraping en progreso...';
            
            // Resetear todos los pasos
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).className = 'progress-step';
                document.getElementById(`progress${i}-bar`).style.width = '0%';
                document.getElementById(`progress${i}-bar`).className = 'progress-bar';
                document.getElementById(`progress${i}-percent`).textContent = '0%';
                document.getElementById(`progress${i}-msg`).textContent = 'Esperando...';
            }
            
            try {
                // Iniciar scraping
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        platform: platform,
                        search_term: searchTerm,
                        num_products: numProducts
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    statusDiv.className = 'alert alert-danger mt-3';
                    statusDiv.textContent = `‚ùå Error: ${result.error}`;
                    scrapeBtn.disabled = false;
                    scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                    progressContainer.classList.add('d-none');
                    return;
                }
                
                // Conectar al stream de progreso (SSE)
                const jobId = result.job_id;
                const eventSource = new EventSource(`/scrape/progress/${jobId}`);
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    // Ignorar keepalive
                    if (data.keepalive) return;
                    
                    // Actualizar paso espec√≠fico
                    const step = data.step;
                    const stepEl = document.getElementById(`step${step}`);
                    const barEl = document.getElementById(`progress${step}-bar`);
                    const percentEl = document.getElementById(`progress${step}-percent`);
                    const msgEl = document.getElementById(`progress${step}-msg`);
                    
                    // Actualizar clase del paso
                    stepEl.className = `progress-step ${data.status}`;
                    
                    // Actualizar barra de progreso solo si hay un nuevo valor
                    if (data.progress !== undefined) {
                        barEl.style.width = `${data.progress}%`;
                        percentEl.textContent = `${data.progress}%`;
                    }
                    
                    // Actualizar clase de la barra
                    if (data.status === 'completed') {
                        barEl.className = 'progress-bar completed';
                        barEl.style.width = '100%';
                        percentEl.textContent = '100%';
                    } else if (data.status === 'error') {
                        barEl.className = 'progress-bar error';
                    }
                    
                    // Actualizar mensaje
                    msgEl.textContent = data.message;
                    
                    // Si es el √∫ltimo paso y est√° completado, mostrar bot√≥n de recarga
                    if (step === 4 && data.status === 'completed') {
                        reloadBtn.classList.remove('d-none');
                        scrapeBtn.disabled = false;
                        scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                        
                        // Auto-reload de tablas
                        loadTables();
                    }
                    
                    // Si hay error en alg√∫n paso
                    if (data.status === 'error') {
                        eventSource.close();
                        scrapeBtn.disabled = false;
                        scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                        statusDiv.className = 'alert alert-danger mt-3';
                        statusDiv.textContent = '‚ùå El proceso fall√≥. Revisa los pasos anteriores.';
                    }
                };
                
                eventSource.onerror = function(error) {
                    console.error('EventSource error:', error);
                    eventSource.close();
                    scrapeBtn.disabled = false;
                    scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                };
                
            } catch (error) {
                statusDiv.className = 'alert alert-danger mt-3';
                statusDiv.textContent = `‚ùå Error de conexi√≥n: ${error.message}`;
                scrapeBtn.disabled = false;
                scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                progressContainer.classList.add('d-none');
            }
        }
        
        // Permitir scraping con Enter
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchTermInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    startScraping();
                }
            });
        });
        
        function clearQuery() {
            document.getElementById('queryInput').value = '';
            document.getElementById('results').innerHTML = `
                <div class="text-center text-muted p-5">
                    <i class="bi bi-play-circle" style="font-size: 4rem; opacity: 0.2;"></i>
                    <p class="mt-3">Ejecuta una consulta SQL para ver los resultados aqu√≠</p>
                </div>
            `;
        }
        
        async function executeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            const resultsDiv = document.getElementById('results');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="alert alert-warning mb-0"><i class="bi bi-exclamation-triangle"></i> Por favor ingresa una consulta SQL</div>';
                return;
            }
            
            resultsDiv.innerHTML = `
                <div class="text-center text-muted p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Ejecutando consulta...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.data) {
                        displayResults(result);
                        // Guardar resultados para gr√°ficos
                        prepareChartData(result);
                    } else {
                        resultsDiv.innerHTML = `<div class="alert alert-success mb-0"><i class="bi bi-check-circle"></i> ${result.message}</div>`;
                    }
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-x-circle"></i> Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-x-circle"></i> Error de conexi√≥n: ${error.message}</div>`;
            }
        }
        
        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            
            let html = '<div class="card shadow-sm">';
            html += '<div class="card-header bg-light">';
            html += `<span class="text-muted"><i class="bi bi-graph-up"></i> <strong>${result.row_count}</strong> filas encontradas</span>`;
            html += '</div>';
            
            // Recolectar URLs de im√°genes
            let imageUrls = [];
            
            if (result.data.length > 0) {
                html += '<div class="table-responsive">';
                html += '<table class="table table-striped table-hover mb-0">';
                html += '<thead class="table-light"><tr>';
                
                result.columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                result.data.forEach(row => {
                    html += '<tr>';
                    result.columns.forEach(col => {
                        let value = row[col];
                        
                        // Detectar URLs de im√°genes - Sistema robusto multi-plataforma
                        if (typeof value === 'string' && isImageUrl(value)) {
                            imageUrls.push(value);
                            // Mostrar thumbnail en la tabla
                            html += `<td><a href="${value}" target="_blank" title="Ver imagen completa"><img src="${value}" style="max-width: 50px; max-height: 50px; cursor: pointer;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect width=%2250%22 height=%2250%22 fill=%22%23eee%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2212%22%3E‚úó%3C/text%3E%3C/svg%3E'"></a></td>`;
                        } else {
                            if (value === null) value = '<em style="color: #999;">NULL</em>';
                            else if (typeof value === 'object') {
                                // Limitar objetos JSON a 100 caracteres
                                let jsonStr = JSON.stringify(value);
                                value = jsonStr.length > 100 ? jsonStr.substring(0, 100) + '...' : jsonStr;
                            }
                            else if (typeof value === 'boolean') value = value ? '‚úì' : '‚úó';
                            else if (typeof value === 'string') {
                                // Limitar strings largos a 150 caracteres
                                if (value.length > 150) {
                                    value = `<span title="${value.replace(/"/g, '&quot;')}">${value.substring(0, 150)}...</span>`;
                                }
                            }
                            html += `<td>${value}</td>`;
                        }
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += '</div>';
            } else {
                html += '<div style="padding: 20px; text-align: center; color: #666;">No se encontraron resultados</div>';
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
            
            // Actualizar galer√≠a de im√°genes
            updateImageGallery(imageUrls);
        }
        
        // ========== GALER√çA DE IM√ÅGENES ==========
        let currentImages = [];
        let currentImageSize = 150;
        
        /**
         * Funci√≥n robusta para detectar URLs de im√°genes de m√∫ltiples plataformas
         * Soporta: Amazon, El Corte Ingl√©s, URLs con extensiones de imagen, y par√°metros de query
         */
        function isImageUrl(url) {
            if (!url || typeof url !== 'string') return false;
            
            // Convertir a min√∫sculas para comparaci√≥n
            const urlLower = url.toLowerCase();
            
            // 1. Extensiones de imagen comunes (con o sin par√°metros de query)
            const imageExtensions = /\.(jpg|jpeg|png|gif|webp|bmp|svg|ico|tiff|tif)(\?|$)/i;
            if (imageExtensions.test(url)) return true;
            
            // 2. URLs de Amazon (m√∫ltiples variantes)
            const amazonPatterns = [
                'media-amazon.com/images/',
                'm.media-amazon.com/images/',
                'images-na.ssl-images-amazon.com',
                'images-eu.ssl-images-amazon.com',
                'images.amazon.com'
            ];
            if (amazonPatterns.some(pattern => urlLower.includes(pattern))) return true;
            
            // 3. URLs de El Corte Ingl√©s
            const corteInglesPatterns = [
                'dam.elcorteingles.es',
                'supermercado.elcorteingles.es'
            ];
            if (corteInglesPatterns.some(pattern => urlLower.includes(pattern))) return true;
            
            // 4. Otras plataformas comunes de e-commerce
            const ecommercePatterns = [
                'cdn.shopify.com',
                'alicdn.com',
                'static.zara.net',
                'img.ltwebstatic.com', // Shein
                'ae01.alicdn.com', // AliExpress
                'i.ebayimg.com'
            ];
            if (ecommercePatterns.some(pattern => urlLower.includes(pattern))) return true;
            
            // 5. URLs con par√°metros t√≠picos de im√°genes
            const imageParams = ['impolicy=', 'width=', 'height=', 'resize', 'format='];
            if (imageParams.some(param => urlLower.includes(param)) && urlLower.startsWith('http')) {
                return true;
            }
            
            // 6. Data URLs de im√°genes
            if (urlLower.startsWith('data:image/')) return true;
            
            return false;
        }
        
        function updateImageGallery(imageUrls) {
            currentImages = imageUrls;
            const gallery = document.getElementById('imageGallery');
            const countBadge = document.getElementById('imageCount');
            
            countBadge.textContent = `${imageUrls.length} ${imageUrls.length === 1 ? 'imagen' : 'im√°genes'}`;
            
            if (imageUrls.length === 0) {
                gallery.innerHTML = `
                    <div class="col-12 text-center text-muted p-4">
                        <i class="bi bi-images" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">No se encontraron URLs de im√°genes en los resultados</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            imageUrls.forEach((url, index) => {
                html += `
                    <div class="col">
                        <div class="card border shadow-sm" style="cursor: pointer;" onclick="openImageModal('${url.replace(/'/g, "\\'")}', ${index})">
                            <img src="${url}" 
                                 class="card-img-top" 
                                 style="width: ${currentImageSize}px; height: ${currentImageSize}px; object-fit: cover;"
                                 loading="lazy"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22${currentImageSize}%22 height=%22${currentImageSize}%22%3E%3Crect width=%22${currentImageSize}%22 height=%22${currentImageSize}%22 fill=%22%23eee%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2220%22%3E‚úó%3C/text%3E%3C/svg%3E'">
                            <div class="card-body p-2 text-center">
                                <small class="text-muted">#${index + 1}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            gallery.innerHTML = html;
        }
        
        function updateImageSize(size) {
            currentImageSize = parseInt(size);
            updateImageGallery(currentImages);
        }
        
        function openImageModal(url, index) {
            // Crear modal din√°mico para ver imagen en grande
            const modalHtml = `
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Imagen #${index + 1} de ${currentImages.length}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="${url}" class="img-fluid" style="max-height: 70vh;">
                                <div class="mt-3 d-flex flex-wrap gap-2 justify-content-center">
                                    <a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-box-arrow-up-right"></i> Abrir en nueva pesta√±a
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${url.replace(/'/g, "\\'")}')">
                                        <i class="bi bi-clipboard"></i> Copiar URL
                                    </button>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-success" onclick="saveImageToServer('${url.replace(/'/g, "\\'")}', 'png', ${index})">
                                            <i class="bi bi-download"></i> PNG
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="saveImageToServer('${url.replace(/'/g, "\\'")}', 'jpeg', ${index})">
                                            <i class="bi bi-download"></i> JPEG
                                        </button>
                                    </div>
                                </div>
                                <div id="saveImageStatus-${index}" class="mt-2"></div>
                            </div>
                            <div class="modal-footer justify-content-between">
                                <button class="btn btn-secondary" onclick="navigateImage(${index - 1})" ${index === 0 ? 'disabled' : ''}>
                                    <i class="bi bi-arrow-left"></i> Anterior
                                </button>
                                <small class="text-muted text-truncate" style="max-width: 60%;" title="${url}">${url}</small>
                                <button class="btn btn-secondary" onclick="navigateImage(${index + 1})" ${index === currentImages.length - 1 ? 'disabled' : ''}>
                                    Siguiente <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Eliminar modal anterior si existe
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Agregar nuevo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
            
            // Limpiar al cerrar
            document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
        
        async function saveImageToServer(imageUrl, format, index) {
            const statusDiv = document.getElementById(`saveImageStatus-${index}`);
            
            try {
                statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Guardando...</span></div>';
                
                // Generar nombre de archivo basado en la URL o √≠ndice
                const urlParts = imageUrl.split('/');
                const urlFileName = urlParts[urlParts.length - 1].split('.')[0] || `imagen_${index + 1}`;
                const filename = `producto_${urlFileName}`;
                
                const response = await fetch('/images/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageUrl: imageUrl,
                        filename: filename,
                        format: format
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success alert-sm py-2 px-3 mb-0">
                            <i class="bi bi-check-circle"></i> ${result.message}
                        </div>
                    `;
                    
                    // Limpiar mensaje despu√©s de 3 segundos
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger alert-sm py-2 px-3 mb-0">
                            <i class="bi bi-x-circle"></i> Error: ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger alert-sm py-2 px-3 mb-0">
                        <i class="bi bi-x-circle"></i> Error de conexi√≥n: ${error.message}
                    </div>
                `;
            }
        }
        
        function navigateImage(index) {
            if (index >= 0 && index < currentImages.length) {
                openImageModal(currentImages[index], index);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Mostrar feedback temporal
                const btn = event.target.closest('button');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i> Copiado!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            });
        }
        
        // ========== GENERADOR DE GR√ÅFICOS ==========
        let currentChartData = null;
        let chartInstance = null;
        
        function prepareChartData(result) {
            if (!result.data || result.data.length === 0) {
                return;
            }
            
            currentChartData = result;
            
            // Mostrar configuraci√≥n y ocultar placeholder
            document.getElementById('chartConfigSection').classList.remove('d-none');
            document.getElementById('chartPlaceholder').classList.add('d-none');
            
            // Llenar selectores de columnas
            const labelSelect = document.getElementById('chartLabelColumn');
            const dataSelect = document.getElementById('chartDataColumn');
            
            labelSelect.innerHTML = '<option value="">-- Selecciona columna --</option>';
            dataSelect.innerHTML = '<option value="">-- Selecciona columna --</option>';
            
            result.columns.forEach(col => {
                labelSelect.innerHTML += `<option value="${col}">${col}</option>`;
                dataSelect.innerHTML += `<option value="${col}">${col}</option>`;
            });
            
            // Auto-seleccionar sugerencias inteligentes
            if (result.columns.length >= 2) {
                // Primera columna como etiqueta
                labelSelect.value = result.columns[0];
                // Segunda columna num√©rica como datos
                for (let i = 1; i < result.columns.length; i++) {
                    const col = result.columns[i];
                    const firstValue = result.data[0][col];
                    if (typeof firstValue === 'number' || !isNaN(parseFloat(firstValue))) {
                        dataSelect.value = col;
                        break;
                    }
                }
            }
        }
        
        function generateChart() {
            if (!currentChartData) {
                alert('Primero ejecuta una consulta SQL');
                return;
            }
            
            const chartType = document.getElementById('chartType').value;
            const labelColumn = document.getElementById('chartLabelColumn').value;
            const dataColumn = document.getElementById('chartDataColumn').value;
            const chartTitle = document.getElementById('chartTitle').value || 'Gr√°fico';
            
            if (!labelColumn || !dataColumn) {
                alert('Selecciona columnas para el eje X y el eje Y');
                return;
            }
            
            // Extraer datos
            const labels = currentChartData.data.map(row => String(row[labelColumn]));
            const data = currentChartData.data.map(row => {
                const value = row[dataColumn];
                return typeof value === 'number' ? value : parseFloat(value) || 0;
            });
            
            // Limitar a 50 puntos de datos para evitar saturaci√≥n
            const maxDataPoints = 50;
            const displayLabels = labels.slice(0, maxDataPoints);
            const displayData = data.slice(0, maxDataPoints);
            
            // Colores vibrantes
            const colors = [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(237, 100, 166, 0.8)',
                'rgba(255, 154, 158, 0.8)',
                'rgba(250, 208, 196, 0.8)',
                'rgba(52, 211, 153, 0.8)',
                'rgba(96, 165, 250, 0.8)',
                'rgba(251, 191, 36, 0.8)',
                'rgba(248, 113, 113, 0.8)',
                'rgba(167, 139, 250, 0.8)'
            ];
            
            // Generar colores para cada punto de datos
            const backgroundColors = displayData.map((_, idx) => colors[idx % colors.length]);
            const borderColors = backgroundColors.map(color => color.replace('0.8', '1'));
            
            // Destruir gr√°fico anterior si existe
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Mostrar contenedor del gr√°fico
            document.getElementById('chartContainer').classList.remove('d-none');
            
            // Crear nuevo gr√°fico
            const ctx = document.getElementById('myChart').getContext('2d');
            
            const config = {
                type: chartType,
                data: {
                    labels: displayLabels,
                    datasets: [{
                        label: dataColumn,
                        data: displayData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: chartType === 'pie' || chartType === 'doughnut',
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: chartTitle,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#667eea'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: chartType !== 'pie' && chartType !== 'doughnut' && chartType !== 'radar' && chartType !== 'polarArea' ? {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    } : {}
                }
            };
            
            chartInstance = new Chart(ctx, config);
            
            // Habilitar bot√≥n de guardar
            document.getElementById('saveChartBtn').disabled = false;
            
            // Mostrar mensaje si se limitaron los datos
            if (labels.length > maxDataPoints) {
                const notification = document.createElement('div');
                notification.className = 'alert alert-warning alert-dismissible fade show mt-2';
                notification.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i> 
                    Mostrando solo los primeros ${maxDataPoints} de ${labels.length} registros
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.getElementById('chartContainer').parentElement.insertBefore(
                    notification, 
                    document.getElementById('chartContainer')
                );
            }
        }
        
        function clearChart() {
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            document.getElementById('chartContainer').classList.add('d-none');
            document.getElementById('chartTitle').value = '';
            document.getElementById('saveChartBtn').disabled = true;
        }
        
        function showSaveChartModal() {
            if (!chartInstance) {
                alert('‚ö†Ô∏è Primero genera un gr√°fico para guardarlo');
                return;
            }
            
            // Sugerir nombre basado en el t√≠tulo del gr√°fico
            const chartTitle = document.getElementById('chartTitle').value.trim();
            if (chartTitle) {
                const sanitizedName = chartTitle.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '_')
                    .replace(/^_+|_+$/g, '');
                document.getElementById('chartFileName').value = sanitizedName || 'grafico';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('saveChartModal'));
            modal.show();
        }
        
        function updateChartDimensions() {
            const preset = document.getElementById('chartSizePreset').value;
            const customInputs = document.getElementById('customSizeInputs');
            const widthInput = document.getElementById('chartWidth');
            const heightInput = document.getElementById('chartHeight');
            
            if (preset === 'custom') {
                customInputs.classList.remove('d-none');
            } else {
                customInputs.classList.add('d-none');
                
                const sizes = {
                    small: [800, 600],
                    medium: [1200, 800],
                    large: [1920, 1080],
                    xlarge: [2560, 1440]
                };
                
                if (sizes[preset]) {
                    widthInput.value = sizes[preset][0];
                    heightInput.value = sizes[preset][1];
                }
            }
        }
        
        async function downloadChart() {
            if (!chartInstance) {
                alert('‚ö†Ô∏è No hay gr√°fico para guardar');
                return;
            }
            
            const fileName = document.getElementById('chartFileName').value.trim() || 'grafico';
            const format = document.querySelector('input[name="chartFormat"]:checked').value;
            const width = parseInt(document.getElementById('chartWidth').value);
            const height = parseInt(document.getElementById('chartHeight').value);
            
            try {
                if (format === 'png') {
                    await saveChartToServer(fileName, width, height, 'png');
                } else if (format === 'svg') {
                    await saveChartToServer(fileName, width, height, 'svg');
                }
            } catch (error) {
                alert('‚ùå Error al guardar: ' + error.message);
            }
        }
        
        async function saveChartToServer(fileName, width, height, format) {
            // Crear una configuraci√≥n de gr√°fico especial para exportaci√≥n con fondo negro y etiquetas
            const chartType = document.getElementById('chartType').value;
            const chartTitle = document.getElementById('chartTitle').value || 'Gr√°fico';
            const labelColumn = document.getElementById('chartLabelColumn').value;
            const dataColumn = document.getElementById('chartDataColumn').value;
            
            // Extraer datos del gr√°fico actual
            const chartData = chartInstance.data;
            const labels = chartData.labels;
            const data = chartData.datasets[0].data;
            
            // Crear un canvas temporal con las dimensiones deseadas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Colores vibrantes para fondo negro
            const colors = [
                'rgba(102, 126, 234, 0.9)',
                'rgba(118, 75, 162, 0.9)',
                'rgba(237, 100, 166, 0.9)',
                'rgba(255, 154, 158, 0.9)',
                'rgba(250, 208, 196, 0.9)',
                'rgba(52, 211, 153, 0.9)',
                'rgba(96, 165, 250, 0.9)',
                'rgba(251, 191, 36, 0.9)',
                'rgba(248, 113, 113, 0.9)',
                'rgba(167, 139, 250, 0.9)'
            ];
            
            const backgroundColors = data.map((_, idx) => colors[idx % colors.length]);
            const borderColors = backgroundColors.map(color => color.replace('0.9', '1'));
            
            // Configuraci√≥n del gr√°fico para exportaci√≥n con fondo negro
            const exportConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: dataColumn,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 3,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            display: chartType === 'pie' || chartType === 'doughnut',
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                font: { size: 14 }
                            }
                        },
                        title: {
                            display: true,
                            text: chartTitle,
                            color: '#ffffff',
                            font: {
                                size: 24,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        // Plugin para mostrar etiquetas de datos
                        datalabels: {
                            display: true,
                            color: '#ffffff',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            formatter: (value) => value.toLocaleString(),
                            anchor: chartType === 'bar' ? 'end' : 'center',
                            align: chartType === 'bar' ? 'end' : 'center'
                        }
                    },
                    scales: chartType !== 'pie' && chartType !== 'doughnut' && chartType !== 'radar' && chartType !== 'polarArea' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { size: 12 }
                            },
                            grid: {
                                display: false
                            }
                        }
                    } : {}
                },
                plugins: [{
                    // Plugin personalizado para dibujar etiquetas de datos
                    id: 'dataLabels',
                    afterDatasetsDraw: (chart) => {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            if (!meta.hidden) {
                                meta.data.forEach((element, index) => {
                                    ctx.fillStyle = '#ffffff';
                                    ctx.font = 'bold 14px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    
                                    const dataValue = dataset.data[index];
                                    const text = dataValue.toLocaleString();
                                    
                                    let x = element.x;
                                    let y = element.y;
                                    
                                    // Ajustar posici√≥n seg√∫n tipo de gr√°fico
                                    if (chart.config.type === 'bar') {
                                        y -= 10;
                                    } else if (chart.config.type === 'line') {
                                        y -= 15;
                                    }
                                    
                                    ctx.fillText(text, x, y);
                                });
                            }
                        });
                    }
                }]
            };
            
            // Crear gr√°fico temporal en el canvas
            const tempChart = new Chart(tempCtx, exportConfig);
            
            // Esperar a que se renderice
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Fondo negro
            const imageDataUrl = tempCanvas.toDataURL('image/png', 1.0);
            tempChart.destroy();
            
            // Crear canvas final con fondo negro
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = width;
            finalCanvas.height = height;
            const finalCtx = finalCanvas.getContext('2d');
            
            // Pintar fondo negro
            finalCtx.fillStyle = '#000000';
            finalCtx.fillRect(0, 0, width, height);
            
            // Cargar y dibujar la imagen del gr√°fico
            const img = new Image();
            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
                img.src = imageDataUrl;
            });
            
            finalCtx.drawImage(img, 0, 0, width, height);
            
            // Obtener data URL final
            let imageData;
            if (format === 'png') {
                imageData = finalCanvas.toDataURL('image/png', 1.0);
            } else {
                // Para SVG, crear SVG con imagen embebida
                const pngData = finalCanvas.toDataURL('image/png');
                const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
     width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
    <image width="${width}" height="${height}" xlink:href="${pngData}"/>
</svg>`;
                imageData = 'data:image/svg+xml;base64,' + btoa(svg);
            }
            
            // Enviar al servidor
            const response = await fetch('/charts/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: fileName,
                    image_data: imageData,
                    format: format
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`‚úÖ ${result.message}\n\nüìÇ Guardado en: ${result.filename}`);
                
                // Cerrar el modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('saveChartModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Recargar galer√≠a si existe
                if (typeof loadSavedCharts === 'function') {
                    loadSavedCharts();
                }
            } else {
                throw new Error(result.error);
            }
        }
        // ========== FIN GUARDAR GR√ÅFICOS ==========
        
        // ========== FIN GENERADOR DE GR√ÅFICOS ==========
        
        // ========== CONVERSOR DE TIPOS DE DATOS ==========
        let commonColumnsForConversion = [];
        let tablesWithColumn = {};
        
        async function loadCommonColumnsForConversion() {
            try {
                // Obtener todas las tablas y sus columnas
                const response = await fetch('/columns-by-table');
                const result = await response.json();
                
                if (result.success) {
                    const allTables = result.data;
                    const tableNames = Object.keys(allTables);
                    
                    // Contar frecuencia de columnas
                    const columnFrequency = {};
                    
                    tableNames.forEach(table => {
                        const columns = allTables[table];
                        columns.forEach(col => {
                            if (!columnFrequency[col]) {
                                columnFrequency[col] = {
                                    count: 0,
                                    tables: []
                                };
                            }
                            columnFrequency[col].count++;
                            columnFrequency[col].tables.push(table);
                        });
                    });
                    
                    // Mostrar columnas que aparecen en al menos 2 tablas, ordenadas por frecuencia
                    commonColumnsForConversion = Object.keys(columnFrequency)
                        .filter(col => columnFrequency[col].count >= 2)
                        .sort((a, b) => {
                            // Ordenar por frecuencia descendente, luego alfab√©ticamente
                            if (columnFrequency[b].count !== columnFrequency[a].count) {
                                return columnFrequency[b].count - columnFrequency[a].count;
                            }
                            return a.localeCompare(b);
                        });
                    
                    // Guardar informaci√≥n de tablas
                    tablesWithColumn = columnFrequency;
                    
                    // Llenar selector con informaci√≥n de frecuencia
                    const select = document.getElementById('columnToConvert');
                    select.innerHTML = '<option value="">-- Selecciona una columna --</option>';
                    commonColumnsForConversion.forEach(col => {
                        const frequency = columnFrequency[col].count;
                        select.innerHTML += `<option value="${col}">${col} (${frequency} tablas)</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading columns for conversion:', error);
            }
        }
        
        async function updateConversionPreview() {
            const column = document.getElementById('columnToConvert').value;
            const convertButton = document.getElementById('convertButton');
            
            if (!column) {
                document.getElementById('conversionPreview').classList.add('d-none');
                document.getElementById('tablesList').innerHTML = '<span class="text-muted">Selecciona una columna primero</span>';
                document.getElementById('tablesCount').textContent = '0';
                convertButton.disabled = true;
                return;
            }
            
            convertButton.disabled = false;
            
            // Mostrar tablas afectadas
            const tables = tablesWithColumn[column].tables;
            document.getElementById('tablesCount').textContent = tables.length;
            document.getElementById('tablesList').innerHTML = tables
                .map(t => `<span class="badge bg-secondary me-1 mb-1">${t}</span>`)
                .join('');
            
            // Obtener muestra de datos de la primera tabla
            try {
                const firstTable = tables[0];
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: `SELECT ${column} FROM ${firstTable} WHERE ${column} IS NOT NULL LIMIT 5;` 
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    document.getElementById('conversionPreview').classList.remove('d-none');
                    let html = `<strong>Tabla: ${firstTable}</strong><br>`;
                    html += '<table class="table table-sm table-bordered mb-0">';
                    html += '<thead><tr><th>Valor Original</th><th>‚Üí</th><th>Valor Convertido</th></tr></thead><tbody>';
                    
                    result.data.forEach(row => {
                        const original = String(row[column]);
                        const converted = original.replace(/[^\d.,\-]/g, '').replace(',', '.');
                        html += `<tr>
                            <td>${original}</td>
                            <td>‚Üí</td>
                            <td class="text-success fw-bold">${converted || '0'}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    document.getElementById('previewContent').innerHTML = html;
                } else {
                    document.getElementById('conversionPreview').classList.add('d-none');
                }
            } catch (error) {
                console.error('Error loading preview:', error);
            }
        }
        
        async function convertColumnType() {
            const column = document.getElementById('columnToConvert').value;
            const newColumnName = document.getElementById('newColumnName').value.trim();
            const targetType = document.getElementById('targetDataType').value;
            
            if (!column) {
                return;
            }
            
            if (!newColumnName) {
                return;
            }
            
            // Validar nombre de columna (solo letras min√∫sculas, n√∫meros y guiones bajos)
            if (!/^[a-z_][a-z0-9_]*$/.test(newColumnName)) {
                return;
            }
            
            const tables = tablesWithColumn[column].tables;
            
            if (!confirm(`‚úÖ ¬øCrear columna "${newColumnName}" (tipo ${targetType}) en ${tables.length} tablas?\n\nSe copiar√° "${column}" limpiando s√≠mbolos.\nLa columna original se mantendr√° sin cambios.`)) {
                return;
            }
            
            // Mostrar progreso
            document.getElementById('conversionProgress').classList.remove('d-none');
            document.getElementById('convertButton').disabled = true;
            
            try {
                const response = await fetch('/convert-column-type', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        column: column,
                        new_column_name: newColumnName,
                        target_type: targetType,
                        tables: tables
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('conversionStatus').innerHTML = 
                        `<span class="text-success">‚úÖ ${result.message}</span>`;
                    document.getElementById('conversionProgressBar').style.width = '100%';
                    document.getElementById('conversionProgressBar').classList.remove('progress-bar-animated');
                    
                    // Recargar tablas
                    setTimeout(() => {
                        loadTables();
                        document.getElementById('conversionProgress').classList.add('d-none');
                        document.getElementById('convertButton').disabled = false;
                        document.getElementById('conversionProgressBar').style.width = '0%';
                        document.getElementById('conversionProgressBar').classList.add('progress-bar-animated');
                    }, 2000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('conversionStatus').innerHTML = 
                    `<span class="text-danger">‚ùå Error: ${error.message}</span>`;
                document.getElementById('convertButton').disabled = false;
            }
        }
        // ========== FIN CONVERSOR DE TIPOS ==========
        
        // ========== GALER√çA DE GR√ÅFICOS GUARDADOS ==========
        async function loadSavedCharts() {
            try {
                const response = await fetch('/charts/list');
                const result = await response.json();
                
                const container = document.getElementById('savedChartsList');
                const countBadge = document.getElementById('chartsCount');
                
                if (result.success && result.charts.length > 0) {
                    countBadge.textContent = result.total;
                    
                    container.innerHTML = result.charts.map((chart, index) => `
                        <div class="card mb-2 chart-item">
                            <div class="row g-0">
                                <div class="col-4">
                                    <img src="${chart.url}" 
                                         class="img-fluid rounded-start" 
                                         alt="${chart.filename}"
                                         style="height: 100px; object-fit: cover; cursor: pointer;"
                                         onclick="addImageToBoard('${chart.url}', '${chart.filename}')"
                                         title="Haz clic para agregar al visualizador">
                                </div>
                                <div class="col-8">
                                    <div class="card-body p-2">
                                        <h6 class="card-title small mb-1 text-truncate" title="${chart.filename}">${chart.filename}</h6>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                <i class="bi bi-calendar"></i> ${chart.created}<br>
                                                <span class="badge bg-light text-dark">${chart.format}</span>
                                                <span class="badge bg-light text-dark">${formatFileSize(chart.size)}</span>
                                            </small>
                                        </p>
                                        <div class="d-flex gap-1">
                                            <a href="${chart.url}" download="${chart.filename}" class="btn btn-sm btn-outline-primary" title="Descargar">
                                                <i class="bi bi-download"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteChart('${chart.filename}')" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Agregar event listeners a las im√°genes arrastrables
                    setTimeout(() => {
                        document.querySelectorAll('.image-module').forEach(img => {
                            img.addEventListener('dragstart', handleImageDragStart);
                            img.addEventListener('dragend', handleImageDragEnd);
                        });
                    }, 100);
                    
                } else {
                    countBadge.textContent = '0';
                    container.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-image" style="font-size: 2rem; opacity: 0.3;"></i>
                            <p class="small mt-2">No hay gr√°ficos guardados</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error cargando gr√°ficos:', error);
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // ========== VISUALIZADOR DE IM√ÅGENES ==========
        let boardImages = [];
        let boardImageCounter = 0;
        let selectedBoardImage = null;
        let isDraggingBoardImage = false;
        let isResizingBoardImage = false;
        let boardDragStartX, boardDragStartY, boardImageStartX, boardImageStartY;
        let boardResizeStartWidth, boardResizeStartHeight;
        
        function addImageToBoard(imageUrl, filename) {
            const board = document.getElementById('imageBoard');
            const placeholder = document.getElementById('imageBoardPlaceholder');
            
            if (placeholder) {
                placeholder.remove();
            }
            
            boardImageCounter++;
            const imageId = `board-img-${boardImageCounter}`;
            
            // Posici√≥n inicial aleatoria
            const x = Math.random() * 300 + 50;
            const y = Math.random() * 200 + 50;
            
            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'board-image';
            imageWrapper.id = imageId;
            imageWrapper.style.cssText = `left: ${x}px; top: ${y}px; width: 250px; height: auto;`;
            imageWrapper.dataset.filename = filename;
            
            imageWrapper.innerHTML = `
                <div class="board-image-controls">
                    <button class="btn btn-sm btn-primary" onclick="scaleBoardImage('${imageId}', 1.2)" title="Aumentar">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="scaleBoardImage('${imageId}', 0.8)" title="Reducir">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="removeBoardImage('${imageId}')" title="Eliminar">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <img src="${imageUrl}" alt="${filename}" style="width: 100%; height: auto; display: block;">
                <div class="board-resize-handle"></div>
            `;
            
            board.appendChild(imageWrapper);
            
            // Event listeners para arrastrar
            imageWrapper.addEventListener('mousedown', startDragBoardImage);
            
            // Event listener para resize
            const resizeHandle = imageWrapper.querySelector('.board-resize-handle');
            resizeHandle.addEventListener('mousedown', startResizeBoardImage);
            
            boardImages.push({
                id: imageId,
                url: imageUrl,
                filename: filename,
                x: x,
                y: y
            });
            
            console.log(`‚úÖ Imagen agregada al visualizador: ${filename}`);
        }
        
        function startDragBoardImage(e) {
            if (e.target.classList.contains('board-resize-handle') || 
                e.target.closest('.board-image-controls') ||
                e.target.closest('button')) {
                return;
            }
            
            e.preventDefault();
            isDraggingBoardImage = true;
            selectedBoardImage = this;
            
            this.classList.add('dragging-board', 'selected');
            
            const rect = this.getBoundingClientRect();
            const boardRect = document.getElementById('imageBoard').getBoundingClientRect();
            
            boardDragStartX = e.clientX;
            boardDragStartY = e.clientY;
            boardImageStartX = rect.left - boardRect.left;
            boardImageStartY = rect.top - boardRect.top;
            
            document.addEventListener('mousemove', moveBoardImage);
            document.addEventListener('mouseup', stopDragBoardImage);
        }
        
        function moveBoardImage(e) {
            if (!isDraggingBoardImage || !selectedBoardImage) return;
            
            const deltaX = e.clientX - boardDragStartX;
            const deltaY = e.clientY - boardDragStartY;
            
            const newX = boardImageStartX + deltaX;
            const newY = boardImageStartY + deltaY;
            
            selectedBoardImage.style.left = Math.max(0, newX) + 'px';
            selectedBoardImage.style.top = Math.max(0, newY) + 'px';
        }
        
        function stopDragBoardImage() {
            if (selectedBoardImage) {
                selectedBoardImage.classList.remove('dragging-board');
                setTimeout(() => {
                    if (selectedBoardImage) {
                        selectedBoardImage.classList.remove('selected');
                    }
                }, 300);
            }
            
            isDraggingBoardImage = false;
            selectedBoardImage = null;
            
            document.removeEventListener('mousemove', moveBoardImage);
            document.removeEventListener('mouseup', stopDragBoardImage);
        }
        
        function startResizeBoardImage(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isResizingBoardImage = true;
            selectedBoardImage = this.parentElement;
            selectedBoardImage.classList.add('selected');
            
            boardDragStartX = e.clientX;
            boardDragStartY = e.clientY;
            boardResizeStartWidth = selectedBoardImage.offsetWidth;
            boardResizeStartHeight = selectedBoardImage.offsetHeight;
            
            document.addEventListener('mousemove', resizeBoardImage);
            document.addEventListener('mouseup', stopResizeBoardImage);
        }
        
        function resizeBoardImage(e) {
            if (!isResizingBoardImage || !selectedBoardImage) return;
            
            const deltaX = e.clientX - boardDragStartX;
            
            const newWidth = Math.max(100, boardResizeStartWidth + deltaX);
            selectedBoardImage.style.width = newWidth + 'px';
        }
        
        function stopResizeBoardImage() {
            if (selectedBoardImage) {
                setTimeout(() => {
                    if (selectedBoardImage) {
                        selectedBoardImage.classList.remove('selected');
                    }
                }, 300);
            }
            
            isResizingBoardImage = false;
            selectedBoardImage = null;
            
            document.removeEventListener('mousemove', resizeBoardImage);
            document.removeEventListener('mouseup', stopResizeBoardImage);
        }
        
        function scaleBoardImage(imageId, factor) {
            const img = document.getElementById(imageId);
            if (!img) return;
            
            const currentWidth = img.offsetWidth;
            const newWidth = Math.max(50, Math.min(800, currentWidth * factor));
            img.style.width = newWidth + 'px';
        }
        
        function removeBoardImage(imageId) {
            const img = document.getElementById(imageId);
            if (img) {
                img.remove();
                boardImages = boardImages.filter(i => i.id !== imageId);
                
                // Si no quedan im√°genes, mostrar placeholder
                if (boardImages.length === 0) {
                    const board = document.getElementById('imageBoard');
                    board.innerHTML = `
                        <div class="position-absolute top-50 start-50 translate-middle text-center text-muted" id="imageBoardPlaceholder">
                            <i class="bi bi-images" style="font-size: 4rem; opacity: 0.2;"></i>
                            <p class="mt-3">Haz clic en una imagen de "Gr√°ficos Guardados"<br>para agregarla al visualizador</p>
                        </div>
                    `;
                }
            }
        }
        
        function clearImageBoard() {
            if (boardImages.length === 0) return;
            
            if (!confirm('¬øEliminar todas las im√°genes del visualizador?')) {
                return;
            }
            
            const board = document.getElementById('imageBoard');
            board.innerHTML = `
                <div class="position-absolute top-50 start-50 translate-middle text-center text-muted" id="imageBoardPlaceholder">
                    <i class="bi bi-images" style="font-size: 4rem; opacity: 0.2;"></i>
                    <p class="mt-3">Haz clic en una imagen de "Gr√°ficos Guardados"<br>para agregarla al visualizador</p>
                </div>
            `;
            
            boardImages = [];
            console.log('üóëÔ∏è Visualizador limpiado');
        }
        // ========== FIN VISUALIZADOR DE IM√ÅGENES ==========
        
        function showChartPreview(url, filename) {
            // Crear modal de vista previa
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="bi bi-image"></i> ${filename}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${url}" class="img-fluid" alt="${filename}">
                        </div>
                        <div class="modal-footer">
                            <a href="${url}" download="${filename}" class="btn btn-primary">
                                <i class="bi bi-download"></i> Descargar
                            </a>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }
        
        async function deleteChart(filename) {
            if (!confirm(`¬øEliminar el gr√°fico "${filename}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/charts/delete/${filename}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    loadSavedCharts();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error al eliminar: ' + error.message);
            }
        }
        
        // Cargar gr√°ficos al iniciar
        loadSavedCharts();
        // ========== FIN GALER√çA DE GR√ÅFICOS ==========
        
        // ========== PERSONALIZADOR VISUAL ==========
        
        // Sincronizar color pickers con inputs de texto
        document.getElementById('primaryColor').addEventListener('input', (e) => {
            document.getElementById('primaryColorText').value = e.target.value;
        });
        document.getElementById('secondaryColor').addEventListener('input', (e) => {
            document.getElementById('secondaryColorText').value = e.target.value;
        });
        document.getElementById('bgColor').addEventListener('input', (e) => {
            document.getElementById('bgColorText').value = e.target.value;
        });
        document.getElementById('headingColor').addEventListener('input', (e) => {
            document.getElementById('headingColorText').value = e.target.value;
        });
        document.getElementById('textColor').addEventListener('input', (e) => {
            document.getElementById('textColorText').value = e.target.value;
        });
        document.getElementById('cardBgColor').addEventListener('input', (e) => {
            document.getElementById('cardBgColorText').value = e.target.value;
        });
        document.getElementById('cardBorderColor').addEventListener('input', (e) => {
            document.getElementById('cardBorderColorText').value = e.target.value;
        });
        
        // Sincronizar inputs de texto con color pickers
        document.getElementById('primaryColorText').addEventListener('input', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                document.getElementById('primaryColor').value = e.target.value;
                applyPrimaryColor(e.target.value);
            }
        });
        document.getElementById('secondaryColorText').addEventListener('input', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                document.getElementById('secondaryColor').value = e.target.value;
                applySecondaryColor(e.target.value);
            }
        });
        document.getElementById('bgColorText').addEventListener('input', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                document.getElementById('bgColor').value = e.target.value;
                applyBgColor(e.target.value);
            }
        });
        document.getElementById('headingColorText').addEventListener('input', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                document.getElementById('headingColor').value = e.target.value;
                applyHeadingColor(e.target.value);
            }
        });
        document.getElementById('textColorText').addEventListener('input', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                document.getElementById('textColor').value = e.target.value;
                applyTextColor(e.target.value);
            }
        });
        document.getElementById('cardBgColorText').addEventListener('input', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                document.getElementById('cardBgColor').value = e.target.value;
                applyCardBgColor(e.target.value);
            }
        });
        document.getElementById('cardBorderColorText').addEventListener('input', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                document.getElementById('cardBorderColor').value = e.target.value;
                applyCardBorderColor(e.target.value);
            }
        });
        
        function applyPrimaryColor(color) {
            document.documentElement.style.setProperty('--bs-primary', color);
            document.documentElement.style.setProperty('--primary-color', color);
            
            // Actualizar gradientes
            const gradient = `linear-gradient(135deg, ${color} 0%, ${document.getElementById('secondaryColor').value} 100%)`;
            document.querySelectorAll('.gradient-header').forEach(el => {
                el.style.background = gradient;
            });
            document.body.style.background = gradient;
            
            // Actualizar scrollbars
            document.querySelectorAll('.overflow-auto').forEach(el => {
                el.style.scrollbarColor = `${color} #f1f1f1`;
            });
        }
        
        function applySecondaryColor(color) {
            document.documentElement.style.setProperty('--bs-secondary', color);
            document.documentElement.style.setProperty('--secondary-color', color);
            
            // Actualizar gradientes
            const gradient = `linear-gradient(135deg, ${document.getElementById('primaryColor').value} 0%, ${color} 100%)`;
            document.querySelectorAll('.gradient-header').forEach(el => {
                el.style.background = gradient;
            });
            document.body.style.background = gradient;
        }
        
        function applyBgColor(color) {
            document.querySelectorAll('.container-fluid').forEach(el => {
                el.style.backgroundColor = color;
            });
        }
        
        function applyMainFont(font) {
            document.body.style.fontFamily = font;
        }
        
        function applyFontSize(size) {
            document.getElementById('fontSizeValue').textContent = size + 'px';
            document.body.style.fontSize = size + 'px';
        }
        
        function applyHeadingColor(color) {
            document.querySelectorAll('h1, h2, h3, h4, h5, h6, .card-title').forEach(el => {
                el.style.color = color;
            });
        }
        
        function applyTextColor(color) {
            document.body.style.color = color;
        }
        
        function applyCardBorder(border) {
            if (border === 'custom') {
                // Aplicar borde personalizado
                applyCustomBorder();
            } else {
                document.querySelectorAll('.card').forEach(el => {
                    el.style.border = border;
                });
            }
        }
        
        function applyCardBorderColor(color) {
            const width = document.getElementById('borderWidth').value;
            document.querySelectorAll('.card').forEach(el => {
                el.style.borderColor = color;
                if (el.style.border === '' || el.style.border === 'none') {
                    el.style.border = `${width}px solid ${color}`;
                }
            });
            
            // Si el selector est√° en "Personalizado", actualizar
            if (document.getElementById('cardBorder').value === 'custom') {
                applyCustomBorder();
            }
        }
        
        function applyBorderWidth(width) {
            document.getElementById('borderWidthValue').textContent = width + 'px';
            const color = document.getElementById('cardBorderColor').value;
            
            if (width === '0') {
                document.querySelectorAll('.card').forEach(el => {
                    el.style.border = 'none';
                });
            } else {
                document.querySelectorAll('.card').forEach(el => {
                    el.style.border = `${width}px solid ${color}`;
                });
            }
            
            // Si el selector est√° en "Personalizado", actualizar
            if (document.getElementById('cardBorder').value === 'custom') {
                document.getElementById('cardBorder').value = 'custom';
            }
        }
        
        function applyCustomBorder() {
            const width = document.getElementById('borderWidth').value;
            const color = document.getElementById('cardBorderColor').value;
            
            if (width === '0') {
                document.querySelectorAll('.card').forEach(el => {
                    el.style.border = 'none';
                });
            } else {
                document.querySelectorAll('.card').forEach(el => {
                    el.style.border = `${width}px solid ${color}`;
                });
            }
        }
        
        function applyBorderRadius(radius) {
            document.getElementById('borderRadiusValue').textContent = radius + 'px';
            document.documentElement.style.setProperty('--bs-border-radius', radius + 'px');
            document.querySelectorAll('.card, .btn, .form-control, .form-select').forEach(el => {
                el.style.borderRadius = radius + 'px';
            });
        }
        
        function applyCardBgColor(color) {
            document.querySelectorAll('.card').forEach(el => {
                el.style.backgroundColor = color;
            });
        }
        
        function saveCustomStyles() {
            const styles = {
                primaryColor: document.getElementById('primaryColor').value,
                secondaryColor: document.getElementById('secondaryColor').value,
                bgColor: document.getElementById('bgColor').value,
                mainFont: document.getElementById('mainFont').value,
                fontSize: document.getElementById('fontSize').value,
                headingColor: document.getElementById('headingColor').value,
                textColor: document.getElementById('textColor').value,
                cardBorder: document.getElementById('cardBorder').value,
                borderRadius: document.getElementById('borderRadius').value,
                cardBgColor: document.getElementById('cardBgColor').value,
                cardBorderColor: document.getElementById('cardBorderColor').value,
                borderWidth: document.getElementById('borderWidth').value
            };
            
            localStorage.setItem('customStyles', JSON.stringify(styles));
            alert('‚úÖ Tema guardado correctamente');
        }
        
        function loadCustomStyles() {
            const saved = localStorage.getItem('customStyles');
            if (saved) {
                const styles = JSON.parse(saved);
                
                // Cargar valores en controles
                document.getElementById('primaryColor').value = styles.primaryColor;
                document.getElementById('primaryColorText').value = styles.primaryColor;
                document.getElementById('secondaryColor').value = styles.secondaryColor;
                document.getElementById('secondaryColorText').value = styles.secondaryColor;
                document.getElementById('bgColor').value = styles.bgColor;
                document.getElementById('bgColorText').value = styles.bgColor;
                document.getElementById('mainFont').value = styles.mainFont;
                document.getElementById('fontSize').value = styles.fontSize;
                document.getElementById('fontSizeValue').textContent = styles.fontSize + 'px';
                document.getElementById('headingColor').value = styles.headingColor;
                document.getElementById('headingColorText').value = styles.headingColor;
                document.getElementById('textColor').value = styles.textColor;
                document.getElementById('textColorText').value = styles.textColor;
                document.getElementById('cardBorder').value = styles.cardBorder;
                document.getElementById('borderRadius').value = styles.borderRadius;
                document.getElementById('borderRadiusValue').textContent = styles.borderRadius + 'px';
                document.getElementById('cardBgColor').value = styles.cardBgColor;
                document.getElementById('cardBgColorText').value = styles.cardBgColor;
                
                // Cargar nuevos valores si existen
                if (styles.cardBorderColor) {
                    document.getElementById('cardBorderColor').value = styles.cardBorderColor;
                    document.getElementById('cardBorderColorText').value = styles.cardBorderColor;
                }
                if (styles.borderWidth) {
                    document.getElementById('borderWidth').value = styles.borderWidth;
                    document.getElementById('borderWidthValue').textContent = styles.borderWidth + 'px';
                }
                
                // Aplicar estilos
                applyPrimaryColor(styles.primaryColor);
                applySecondaryColor(styles.secondaryColor);
                applyBgColor(styles.bgColor);
                applyMainFont(styles.mainFont);
                applyFontSize(styles.fontSize);
                applyHeadingColor(styles.headingColor);
                applyTextColor(styles.textColor);
                applyCardBorder(styles.cardBorder);
                applyBorderRadius(styles.borderRadius);
                applyCardBgColor(styles.cardBgColor);
                
                // Aplicar nuevos estilos si existen
                if (styles.cardBorderColor) {
                    applyCardBorderColor(styles.cardBorderColor);
                }
                if (styles.borderWidth) {
                    applyBorderWidth(styles.borderWidth);
                }
            }
        }
        
        function resetStyles() {
            if (confirm('¬øRestaurar todos los estilos a los valores por defecto?')) {
                localStorage.removeItem('customStyles');
                location.reload();
            }
        }
        
        function exportStyles() {
            const styles = {
                primaryColor: document.getElementById('primaryColor').value,
                secondaryColor: document.getElementById('secondaryColor').value,
                bgColor: document.getElementById('bgColor').value,
                mainFont: document.getElementById('mainFont').value,
                fontSize: document.getElementById('fontSize').value,
                headingColor: document.getElementById('headingColor').value,
                textColor: document.getElementById('textColor').value,
                cardBorder: document.getElementById('cardBorder').value,
                borderRadius: document.getElementById('borderRadius').value,
                cardBgColor: document.getElementById('cardBgColor').value,
                cardBorderColor: document.getElementById('cardBorderColor').value,
                borderWidth: document.getElementById('borderWidth').value
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(styles, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "tema_personalizado.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        // Cargar estilos personalizados al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            loadCustomStyles();
        });
        
        // ========== FIN PERSONALIZADOR VISUAL ==========
        
        // ========== MINIMIZAR/RESTAURAR M√ìDULOS ==========
        
        let minimizedModules = new Set();
        
        function minimizeModule(moduleId) {
            const module = document.querySelector(`[data-module-id="${moduleId}"]`);
            if (!module) return;
            
            // Obtener datos del m√≥dulo
            const moduleName = module.dataset.moduleName || moduleId;
            const moduleIcon = module.dataset.moduleIcon || 'bi-square';
            
            // Ocultar m√≥dulo con animaci√≥n
            module.style.transition = 'all 0.3s ease';
            module.style.opacity = '0';
            module.style.transform = 'scale(0.9)';
            
            setTimeout(() => {
                module.style.display = 'none';
                module.style.opacity = '';
                module.style.transform = '';
                
                // A√±adir a la lista de minimizados
                minimizedModules.add(moduleId);
                updateMinimizedToolbar();
                
                // Guardar estado
                saveMinimizedState();
            }, 300);
        }
        
        function restoreModule(moduleId) {
            const module = document.querySelector(`[data-module-id="${moduleId}"]`);
            if (!module) return;
            
            // Restaurar m√≥dulo con animaci√≥n
            module.style.display = '';
            module.style.opacity = '0';
            module.style.transform = 'scale(0.9)';
            
            // Forzar reflow
            module.offsetHeight;
            
            module.style.transition = 'all 0.3s ease';
            module.style.opacity = '1';
            module.style.transform = 'scale(1)';
            
            setTimeout(() => {
                module.style.transition = '';
            }, 300);
            
            // Quitar de la lista de minimizados
            minimizedModules.delete(moduleId);
            updateMinimizedToolbar();
            
            // Guardar estado
            saveMinimizedState();
        }
        
        function updateMinimizedToolbar() {
            const toolbar = document.getElementById('minimizedToolbar');
            const list = document.getElementById('minimizedModulesList');
            
            // Limpiar lista
            list.innerHTML = '';
            
            // Obtener TODOS los m√≥dulos (no solo los minimizados)
            const allModules = document.querySelectorAll('.draggable-module');
            
            if (allModules.length === 0) {
                toolbar.classList.add('hidden');
                return;
            }
            
            toolbar.classList.remove('hidden');
            
            // Obtener orden guardado o usar orden por defecto
            let moduleOrder = JSON.parse(localStorage.getItem('moduleToolbarOrder') || '[]');
            
            // Si no hay orden guardado, usar el orden actual del DOM
            if (moduleOrder.length === 0) {
                allModules.forEach(module => {
                    moduleOrder.push(module.dataset.moduleId);
                });
            }
            
            // Crear mapa de m√≥dulos por ID para acceso r√°pido
            const modulesMap = {};
            allModules.forEach(module => {
                modulesMap[module.dataset.moduleId] = module;
            });
            
            // Crear botones en el orden guardado
            moduleOrder.forEach(moduleId => {
                const module = modulesMap[moduleId];
                if (!module) return; // Skip si el m√≥dulo ya no existe
                
                const moduleName = module.dataset.moduleName || moduleId;
                const moduleIcon = module.dataset.moduleIcon || 'bi-square';
                const isMinimized = minimizedModules.has(moduleId);
                
                const btn = document.createElement('button');
                btn.className = 'minimized-module-btn new';
                btn.draggable = true;
                btn.dataset.moduleId = moduleId;
                
                // Event listeners para drag and drop
                btn.addEventListener('dragstart', handleDragStart);
                btn.addEventListener('dragend', handleDragEnd);
                btn.addEventListener('dragover', handleDragOver);
                btn.addEventListener('drop', handleDrop);
                btn.addEventListener('dragleave', handleDragLeave);
                
                // Si est√° minimizado, restaurar; si est√° visible, minimizar
                btn.onclick = (e) => {
                    // Solo si no estamos arrastrando
                    if (!e.target.classList.contains('dragging')) {
                        if (isMinimized) {
                            restoreModule(moduleId);
                        } else {
                            minimizeModule(moduleId);
                        }
                    }
                };
                
                btn.oncontextmenu = (e) => showModuleContextMenu(e, moduleId);
                btn.title = moduleName + (isMinimized ? ' (minimizado)' : ' (visible)');
                
                // Cambiar opacidad si est√° minimizado
                if (isMinimized) {
                    btn.style.opacity = '0.5';
                } else {
                    btn.style.opacity = '1';
                }
                
                btn.innerHTML = `<i class="bi ${moduleIcon}"></i>`;
                
                list.appendChild(btn);
                
                // Remover clase 'new' despu√©s de la animaci√≥n
                setTimeout(() => btn.classList.remove('new'), 400);
            });
        }
        
        function saveMinimizedState() {
            localStorage.setItem('minimizedModules', JSON.stringify([...minimizedModules]));
        }
        
        function saveToolbarOrder() {
            const list = document.getElementById('minimizedModulesList');
            const buttons = list.querySelectorAll('.minimized-module-btn');
            const order = Array.from(buttons).map(btn => btn.dataset.moduleId);
            localStorage.setItem('moduleToolbarOrder', JSON.stringify(order));
        }
        
        // ========== DRAG AND DROP PARA REORDENAR ICONOS ==========
        let draggedToolbarButton = null;
        
        function handleDragStart(e) {
            draggedToolbarButton = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remover clase drag-over de todos los botones
            document.querySelectorAll('.minimized-module-btn').forEach(btn => {
                btn.classList.remove('drag-over');
            });
            
            draggedToolbarButton = null;
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            e.dataTransfer.dropEffect = 'move';
            
            if (this !== draggedToolbarButton) {
                this.classList.add('drag-over');
            }
            
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedToolbarButton !== this) {
                // Obtener el contenedor
                const list = document.getElementById('minimizedModulesList');
                
                // Obtener posici√≥n del elemento sobre el que se suelta
                const dropIndex = Array.from(list.children).indexOf(this);
                const dragIndex = Array.from(list.children).indexOf(draggedToolbarButton);
                
                // Reordenar elementos
                if (dragIndex < dropIndex) {
                    list.insertBefore(draggedToolbarButton, this.nextSibling);
                } else {
                    list.insertBefore(draggedToolbarButton, this);
                }
                
                // Guardar nuevo orden
                saveToolbarOrder();
            }
            
            this.classList.remove('drag-over');
            return false;
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        // ========== MEN√ö CONTEXTUAL PARA M√ìDULOS ==========
        let contextMenuModuleId = null;
        
        function showModuleContextMenu(event, moduleId) {
            event.preventDefault();
            contextMenuModuleId = moduleId;
            
            const menu = document.getElementById('moduleContextMenu');
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
        }
        
        function duplicateModule() {
            if (!contextMenuModuleId) return;
            
            const originalModule = document.querySelector(`[data-module-id="${contextMenuModuleId}"]`);
            if (!originalModule) return;
            
            // Generar un nuevo ID √∫nico
            const timestamp = Date.now();
            const newModuleId = `${contextMenuModuleId}-copy-${timestamp}`;
            
            // Clonar el m√≥dulo
            const clonedModule = originalModule.cloneNode(true);
            
            // Actualizar el ID
            clonedModule.setAttribute('data-module-id', newModuleId);
            
            // Obtener el tama√±o actual del canvas
            const canvasSlider = document.getElementById('canvasSizeSlider');
            const canvasSize = parseInt(canvasSlider?.value || 1200);
            
            // Obtener el √°rea visible del canvas
            const workspaceCanvas = document.getElementById('workspaceCanvas');
            const scrollLeft = workspaceCanvas.scrollLeft;
            const scrollTop = workspaceCanvas.scrollTop;
            const viewportWidth = workspaceCanvas.clientWidth;
            const viewportHeight = workspaceCanvas.clientHeight;
            
            // Obtener dimensiones del m√≥dulo
            const moduleWidth = parseInt(clonedModule.style.width) || 400;
            const moduleHeight = parseInt(clonedModule.style.height) || 300;
            
            // Calcular posici√≥n aleatoria dentro del √°rea visible
            const maxLeft = Math.min(scrollLeft + viewportWidth - moduleWidth - 50, canvasSize - moduleWidth - 50);
            const maxTop = Math.min(scrollTop + viewportHeight - moduleHeight - 50, canvasSize - moduleHeight - 50);
            const minLeft = Math.max(scrollLeft + 20, 20);
            const minTop = Math.max(scrollTop + 20, 20);
            
            const newLeft = Math.floor(Math.random() * (maxLeft - minLeft) + minLeft);
            const newTop = Math.floor(Math.random() * (maxTop - minTop) + minTop);
            
            clonedModule.style.left = newLeft + 'px';
            clonedModule.style.top = newTop + 'px';
            clonedModule.style.display = '';
            
            // Actualizar el bot√≥n de minimizar
            const minimizeBtn = clonedModule.querySelector('[onclick*="minimizeModule"]');
            if (minimizeBtn) {
                minimizeBtn.setAttribute('onclick', `minimizeModule('${newModuleId}')`);
            }
            
            // Agregar al canvas
            const modulesGrid = document.getElementById('modulesGrid');
            modulesGrid.appendChild(clonedModule);
            
            // Inicializar drag and resize para el nuevo m√≥dulo
            initSingleModuleDragAndResize(clonedModule);
            
            // Actualizar la toolbar para incluir el nuevo m√≥dulo
            updateMinimizedToolbar();
            
            // Ocultar men√∫ contextual
            hideContextMenu();
            
            console.log(`üìã M√≥dulo duplicado: ${contextMenuModuleId} ‚Üí ${newModuleId} en posici√≥n (${newLeft}, ${newTop})`);
        }
        
        function initSingleModuleDragAndResize(module) {
            const grid = document.getElementById('modulesGrid');
            
            // Configurar drag - mismo sistema que los m√≥dulos originales
            module.draggable = false;
            
            // Event listeners principales de drag
            module.addEventListener('dragstart', handleDragStart);
            module.addEventListener('dragend', handleDragEnd);
            module.addEventListener('dragenter', handleDragEnter);
            module.addEventListener('dragleave', handleDragLeave);
            
            // Configurar el drag-handle
            const dragHandle = module.querySelector('.drag-handle');
            if (dragHandle) {
                dragHandle.addEventListener('mousedown', () => {
                    module.draggable = true;
                });
                dragHandle.addEventListener('mouseup', () => {
                    module.draggable = false;
                });
            }
            
            // Prevenir que los controles interactivos interfieran
            const interactiveElements = module.querySelectorAll('input[type="range"], input[type="color"], input[type="text"], select, textarea, button:not(.drag-handle)');
            interactiveElements.forEach(element => {
                element.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    module.draggable = false;
                });
                element.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            // Configurar resize - mismo sistema que los m√≥dulos originales
            const resizeHandles = module.querySelectorAll('.resize-handle');
            resizeHandles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    currentResizingModule = module;
                    isResizing = true;
                    
                    const rect = module.getBoundingClientRect();
                    resizeStartX = e.clientX;
                    resizeStartY = e.clientY;
                    resizeStartWidth = rect.width;
                    resizeStartHeight = rect.height;
                    
                    // Determinar qu√© tipo de resize es
                    if (handle.classList.contains('resize-right')) {
                        currentResizeType = 'right';
                    } else if (handle.classList.contains('resize-bottom')) {
                        currentResizeType = 'bottom';
                    } else if (handle.classList.contains('resize-corner')) {
                        currentResizeType = 'corner';
                    }
                    
                    module.style.zIndex = '1000';
                    document.addEventListener('mousemove', performResize);
                    document.addEventListener('mouseup', stopResize);
                });
            });
        }
        
        function hideContextMenu() {
            const menu = document.getElementById('moduleContextMenu');
            menu.style.display = 'none';
            contextMenuModuleId = null;
        }
        
        // Cerrar men√∫ contextual al hacer clic fuera
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('moduleContextMenu');
            if (menu && !menu.contains(e.target)) {
                hideContextMenu();
            }
        });
        // ========== FIN MEN√ö CONTEXTUAL ==========
        
        function loadMinimizedState() {
            const saved = localStorage.getItem('minimizedModules');
            if (saved) {
                try {
                    const modules = JSON.parse(saved);
                    modules.forEach(moduleId => {
                        const module = document.querySelector(`[data-module-id="${moduleId}"]`);
                        if (module) {
                            module.style.display = 'none';
                            minimizedModules.add(moduleId);
                        }
                    });
                    updateMinimizedToolbar();
                } catch (e) {
                    console.error('Error loading minimized state:', e);
                }
            }
        }
        
        // Cargar estado de m√≥dulos minimizados al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            loadMinimizedState();
            initializeCanvasSizeSlider();
            // Inicializar la toolbar con todos los m√≥dulos
            updateMinimizedToolbar();
        });
        
        // ========== CONTROL DE TAMA√ëO DEL CANVAS ==========
        function initializeCanvasSizeSlider() {
            const slider = document.getElementById('canvasSizeSlider');
            const label = document.getElementById('canvasSizeLabel');
            const modulesGrid = document.getElementById('modulesGrid');
            
            // Cargar tama√±o guardado
            const savedSize = localStorage.getItem('canvasSize');
            if (savedSize) {
                const size = parseInt(savedSize);
                slider.value = size;
                updateCanvasSize(size);
            }
            
            // Listener para cambios en el slider
            slider.addEventListener('input', function() {
                const size = parseInt(this.value);
                updateCanvasSize(size);
            });
            
            // Guardar al finalizar el cambio
            slider.addEventListener('change', function() {
                const size = parseInt(this.value);
                localStorage.setItem('canvasSize', size);
                console.log(`üíæ Tama√±o del canvas guardado: ${size}x${size}px`);
            });
        }
        
        function updateCanvasSize(size) {
            const modulesGrid = document.getElementById('modulesGrid');
            const label = document.getElementById('canvasSizeLabel');
            
            modulesGrid.style.minWidth = size + 'px';
            modulesGrid.style.minHeight = size + 'px';
            label.textContent = `${size} x ${size}`;
        }
        // ========== FIN CONTROL DE TAMA√ëO DEL CANVAS ==========
        
        // ========== FIN MINIMIZAR/RESTAURAR M√ìDULOS ==========
        
        // Permitir ejecutar con Ctrl+Enter
        document.getElementById('queryInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery();
            }
        });
    </script>
    
    <!-- Modal para crear vista -->
    <div class="modal fade" id="createViewModal" tabindex="-1" aria-labelledby="createViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="createViewModalLabel"><i class="bi bi-plus-circle"></i> Crear Nueva Vista</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Guarda la consulta actual como una vista reutilizable</p>
                    
                    <div class="mb-3">
                        <label for="viewNameInput" class="form-label fw-bold">Nombre de la vista:</label>
                        <input type="text" class="form-control" id="viewNameInput" placeholder="mi_vista_productos">
                        <small class="text-muted">Solo letras min√∫sculas, n√∫meros y gui√≥n bajo (_)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="viewQueryInput" class="form-label fw-bold">Consulta SQL:</label>
                        <textarea class="form-control font-monospace" id="viewQueryInput" rows="8"></textarea>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="createView()"><i class="bi bi-check-circle"></i> Crear Vista</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para guardar gr√°fico -->
    <div class="modal fade" id="saveChartModal" tabindex="-1" aria-labelledby="saveChartModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="saveChartModalLabel"><i class="bi bi-download"></i> Guardar Gr√°fico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="chartFileName" class="form-label fw-bold">Nombre del archivo:</label>
                        <input type="text" class="form-control" id="chartFileName" placeholder="mi_grafico" value="grafico">
                        <small class="text-muted">Sin extensi√≥n (se a√±adir√° autom√°ticamente)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tama√±o:</label>
                        <select class="form-select" id="chartSizePreset" onchange="updateChartDimensions()">
                            <option value="small">Peque√±o (800 √ó 600)</option>
                            <option value="medium" selected>Mediano (1200 √ó 800)</option>
                            <option value="large">Grande (1920 √ó 1080)</option>
                            <option value="xlarge">Extra Grande (2560 √ó 1440)</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    
                    <div id="customSizeInputs" class="d-none mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small">Ancho (px):</label>
                                <input type="number" class="form-control" id="chartWidth" value="1200" min="400" max="4000">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Alto (px):</label>
                                <input type="number" class="form-control" id="chartHeight" value="800" min="300" max="3000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Formato:</label>
                        <div class="d-flex gap-2">
                            <div class="form-check flex-grow-1">
                                <input class="form-check-input" type="radio" name="chartFormat" id="formatPng" value="png" checked>
                                <label class="form-check-label w-100" for="formatPng">
                                    <div class="border rounded p-2">
                                        <strong>PNG</strong>
                                        <small class="d-block text-muted">Imagen rasterizada, ideal para web</small>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check flex-grow-1">
                                <input class="form-check-input" type="radio" name="chartFormat" id="formatSvg" value="svg">
                                <label class="form-check-label w-100" for="formatSvg">
                                    <div class="border rounded p-2">
                                        <strong>SVG</strong>
                                        <small class="d-block text-muted">Vectorial, escalable sin p√©rdida</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle"></i> <strong>Consejo:</strong> SVG es ideal para impresi√≥n y edici√≥n posterior. PNG es mejor para compartir en redes sociales o documentos.
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="downloadChart()">
                        <i class="bi bi-download"></i> Descargar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Cargar vistas al iniciar
        loadViews();
        
        function loadViews() {
            fetch('/views')
                .then(response => response.json())
                .then(data => {
                    const viewsList = document.getElementById('viewsList');
                    
                    if (data.success && data.views.length > 0) {
                        viewsList.innerHTML = data.views.map(view => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                <span class="clickable flex-grow-1" onclick="insertAtCursor('${view.name}')">
                                    <i class="bi bi-eye"></i> ${view.name}
                                </span>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editView('${view.name}')" title="Editar vista">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteView('${view.name}')" title="Eliminar vista">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        viewsList.innerHTML = '<div style="color: #999; font-size: 12px; padding: 10px;">No hay vistas guardadas</div>';
                    }
                })
                .catch(error => {
                    console.error('Error cargando vistas:', error);
                    document.getElementById('viewsList').innerHTML = '<div style="color: #dc3545; font-size: 12px; padding: 10px;">Error al cargar vistas</div>';
                });
        }
        
        function showCreateViewDialog() {
            const queryInput = document.getElementById('queryInput');
            const currentQuery = queryInput.value.trim();
            
            if (!currentQuery) {
                alert('‚ö†Ô∏è Primero escribe una consulta SQL para guardar como vista');
                return;
            }
            
            // Resetear el modal a modo creaci√≥n
            resetViewModal();
            
            document.getElementById('viewQueryInput').value = currentQuery;
            
            // Usar API de Bootstrap 5 para mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('createViewModal'));
            modal.show();
        }
        
        function closeCreateViewDialog() {
            // Usar API de Bootstrap 5 para cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createViewModal'));
            if (modal) {
                modal.hide();
            }
        }
        
        function createView() {
            const viewName = document.getElementById('viewNameInput').value.trim();
            const query = document.getElementById('viewQueryInput').value.trim();
            
            if (!viewName || !query) {
                alert('‚ö†Ô∏è El nombre y la consulta son requeridos');
                return;
            }
            
            fetch('/views/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    view_name: viewName,
                    query: query
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    closeCreateViewDialog();
                    loadViews();
                    loadSchema(); // Recargar esquema para incluir la nueva vista
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå Error al crear vista: ' + error);
            });
        }
        
        function editView(viewName) {
            // Obtener la definici√≥n de la vista
            fetch(`/views/definition/${viewName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.definition) {
                        // Llenar el modal con los datos de la vista
                        document.getElementById('viewNameInput').value = viewName;
                        document.getElementById('viewQueryInput').value = data.definition;
                        
                        // Cambiar el t√≠tulo del modal
                        document.getElementById('createViewModalLabel').innerHTML = '<i class="bi bi-pencil"></i> Editar Vista';
                        
                        // Cambiar el texto del bot√≥n de guardar
                        const saveButton = document.querySelector('#createViewModal .btn-primary');
                        saveButton.textContent = 'Actualizar Vista';
                        saveButton.onclick = function() { updateView(viewName); };
                        
                        // Deshabilitar el campo de nombre (no se puede cambiar)
                        document.getElementById('viewNameInput').disabled = true;
                        
                        // Mostrar el modal
                        const modal = new bootstrap.Modal(document.getElementById('createViewModal'));
                        modal.show();
                    } else {
                        alert('‚ùå Error al obtener la definici√≥n de la vista: ' + (data.error || 'Desconocido'));
                    }
                })
                .catch(error => {
                    alert('‚ùå Error al cargar la vista: ' + error);
                });
        }
        
        function updateView(oldViewName) {
            const query = document.getElementById('viewQueryInput').value.trim();
            
            if (!query) {
                alert('‚ö†Ô∏è La consulta es requerida');
                return;
            }
            
            // Primero eliminar la vista antigua
            fetch(`/views/drop/${oldViewName}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Crear la vista actualizada
                    return fetch('/views/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            view_name: oldViewName,
                            query: query
                        })
                    });
                } else {
                    throw new Error(data.error);
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Vista actualizada exitosamente');
                    closeCreateViewDialog();
                    resetViewModal();
                    loadViews();
                } else {
                    alert('‚ùå Error al actualizar vista: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå Error al actualizar vista: ' + error);
            });
        }
        
        function resetViewModal() {
            // Restaurar el modal a su estado original
            document.getElementById('createViewModalLabel').innerHTML = '<i class="bi bi-plus-circle"></i> Crear Nueva Vista';
            const saveButton = document.querySelector('#createViewModal .btn-primary');
            saveButton.textContent = 'Crear Vista';
            saveButton.onclick = createView;
            document.getElementById('viewNameInput').disabled = false;
            document.getElementById('viewNameInput').value = '';
            document.getElementById('viewQueryInput').value = '';
        }
        
        function deleteView(viewName) {
            if (!confirm(`¬øEst√°s seguro de eliminar la vista "${viewName}"?`)) {
                return;
            }
            
            fetch(`/views/drop/${viewName}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    loadViews();
                    loadSchema(); // Recargar esquema
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå Error al eliminar vista: ' + error);
            });
        }
    </script>
    
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
