<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Products - SQL Query Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .scraper-section {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .scraper-form {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .scraper-form input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .scraper-form input[type="number"] {
            width: 120px;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .scraper-form input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .scraper-form button {
            padding: 12px 30px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scraper-form button:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        
        .scraper-form button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .scraper-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 5px;
            font-size: 13px;
            display: none;
        }
        
        .scraper-status.active {
            display: block;
        }
        
        .scraper-status.loading {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .scraper-status.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .scraper-status.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-step {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #e0e0e0;
        }
        
        .progress-step.running {
            border-left-color: #ffc107;
            background: #fff8e1;
        }
        
        .progress-step.completed {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }
        
        .progress-step.error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .progress-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        
        .progress-percentage {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .progress-bar.completed {
            background: linear-gradient(90deg, #4caf50 0%, #45a049 100%);
        }
        
        .progress-bar.error {
            background: linear-gradient(90deg, #f44336 0%, #d32f2f 100%);
        }
        
        .progress-message {
            font-size: 12px;
            color: #666;
            font-family: 'Courier New', monospace;
        }
        
        .reload-button {
            display: none;
            margin-top: 15px;
            padding: 12px 24px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reload-button.active {
            display: inline-block;
        }
        
        .reload-button:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            padding: 20px;
        }
        
        .module {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .module.collapsed .module-content {
            display: none;
        }
        
        .module.dragging {
            opacity: 0.5;
            cursor: move;
        }
        
        .module-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .module-header:active {
            cursor: grabbing;
        }
        
        .module-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .module-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .module-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
        }
        
        .module-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .module-content {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .module.fullscreen {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            z-index: 999;
            max-width: none;
        }
        
        .module.fullscreen .module-content {
            max-height: calc(100vh - 100px);
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .sidebar h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .sample-query {
            background: #f8f9fa;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid #667eea;
            font-size: 13px;
        }
        
        .sample-query:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .sample-query-title {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        .tables-sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .table-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 3px solid #764ba2;
        }
        
        .table-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .table-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .row-count-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .toggle-schema {
            cursor: pointer;
            color: #667eea;
            font-size: 12px;
            user-select: none;
        }
        
        .clickable-table {
            cursor: pointer;
            transition: all 0.2s;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .clickable-table:hover {
            background: #e8eaf6;
            color: #667eea;
            text-decoration: underline;
        }
        
        .table-schema {
            font-size: 11px;
            color: #666;
            font-family: 'Courier New', monospace;
            margin-top: 5px;
            padding-left: 10px;
            display: none;
        }
        
        .table-schema.visible {
            display: block;
        }
        
        .schema-column {
            padding: 3px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .column-name {
            color: #667eea;
            font-weight: 600;
        }
        
        .column-type {
            color: #999;
        }
        
        .query-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .query-editor {
            margin-bottom: 20px;
        }
        
        .query-editor label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        #queryInput {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        #queryInput:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            min-width: 250px;
        }
        
        .autocomplete-suggestions.active {
            display: block;
        }
        
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #e8eaf6;
        }
        
        .autocomplete-type {
            font-size: 10px;
            color: #999;
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        
        .autocomplete-type.keyword {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .autocomplete-type.table {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .autocomplete-type.column {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .sql-helpers {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .sql-helpers-title {
            width: 100%;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .sql-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #667eea;
            color: #667eea;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
        }
        
        .sql-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .sql-btn:active {
            transform: translateY(0);
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-execute {
            background: #667eea;
            color: white;
            flex: 1;
        }
        
        .btn-execute:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-clear {
            background: #6c757d;
            color: white;
        }
        
        .btn-clear:hover {
            background: #5a6268;
        }
        
        .results-section {
            margin-top: 20px;
        }
        
        .results-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px 5px 0 0;
            border-bottom: 2px solid #dee2e6;
        }
        
        .results-stats {
            color: #666;
            font-size: 14px;
        }
        
        .results-stats strong {
            color: #667eea;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .error-message {
            background: #fee;
            border-left: 4px solid #f44336;
            padding: 15px;
            border-radius: 5px;
            color: #c62828;
            margin-top: 20px;
        }
        
        .success-message {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 5px;
            color: #2e7d32;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .info-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .view-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .view-item:hover {
            background: #e3f2fd;
            border-color: #667eea;
            transform: translateX(5px);
        }
        
        .view-name {
            color: #667eea;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .view-delete {
            color: #dc3545;
            font-size: 16px;
            padding: 0 5px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .view-delete:hover {
            opacity: 1;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
        }
        
        .modal h3 {
            margin-top: 0;
            color: #333;
        }
        
        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .tables-sidebar {
                order: 3;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÉÔ∏è Amazon Products - SQL Query Interface</h1>
            <p>Ejecuta consultas SQL directamente sobre la base de datos de productos scraped</p>
        </div>
        
        <div class="scraper-section">
            <h3 style="margin-bottom: 15px; color: #333;">üîç Scraper de Amazon</h3>
            <div class="scraper-form">
                <input type="text" id="searchTermInput" placeholder="Introduce t√©rmino de b√∫squeda (ej: auriculares gaming, cafe organico...)">
                <input type="number" id="numProductsInput" placeholder="# productos" value="50" min="1" max="200">
                <button onclick="startScraping()" id="scrapeBtn">üöÄ Iniciar Scraping</button>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-step" id="step1">
                    <div class="progress-header">
                        <div class="progress-title">1Ô∏è‚É£ Scraping de productos en Amazon</div>
                        <div class="progress-percentage" id="progress1-percent">0%</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress1-bar" style="width: 0%"></div>
                    </div>
                    <div class="progress-message" id="progress1-msg">Esperando...</div>
                </div>
                
                <div class="progress-step" id="step2">
                    <div class="progress-header">
                        <div class="progress-title">2Ô∏è‚É£ Creaci√≥n de archivo JSON</div>
                        <div class="progress-percentage" id="progress2-percent">0%</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress2-bar" style="width: 0%"></div>
                    </div>
                    <div class="progress-message" id="progress2-msg">Esperando...</div>
                </div>
                
                <div class="progress-step" id="step3">
                    <div class="progress-header">
                        <div class="progress-title">3Ô∏è‚É£ Subida a PostgreSQL</div>
                        <div class="progress-percentage" id="progress3-percent">0%</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress3-bar" style="width: 0%"></div>
                    </div>
                    <div class="progress-message" id="progress3-msg">Esperando...</div>
                </div>
                
                <div class="progress-step" id="step4">
                    <div class="progress-header">
                        <div class="progress-title">4Ô∏è‚É£ Finalizando proceso</div>
                        <div class="progress-percentage" id="progress4-percent">0%</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress4-bar" style="width: 0%"></div>
                    </div>
                    <div class="progress-message" id="progress4-msg">Esperando...</div>
                </div>
                
                <button class="reload-button" id="reloadBtn" onclick="window.location.reload()">
                    üîÑ Recargar p√°gina para ver la nueva tabla
                </button>
            </div>
            
            <div id="scraperStatus" class="scraper-status"></div>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <h3>ÔøΩ Columnas m√°s Comunes</h3>
                <div style="font-size: 11px; color: #666; margin-bottom: 10px;">Click para insertar en el cursor</div>
                {% for column in common_columns %}
                <div class="sample-query" onclick="insertAtCursor('{{ column.name }}')">
                    <div class="sample-query-title">
                        <span style="color: #667eea; font-weight: 600;">{{ column.name }}</span>
                        <span style="color: #999; font-size: 10px; margin-left: 5px;">({{ column.frequency }} tablas)</span>
                    </div>
                </div>
                {% endfor %}
                
                {% if not common_columns %}
                <div style="color: #999; font-size: 12px; padding: 10px;">
                    No hay columnas disponibles. Scrape algunos productos primero.
                </div>
                {% endif %}
            </div>
            
            <div class="sidebar">
                <h3>üëÅÔ∏è Vistas Guardadas</h3>
                <div style="font-size: 11px; color: #666; margin-bottom: 10px;">Click para usar en consulta</div>
                <div id="viewsList">
                    <div style="color: #999; font-size: 12px; padding: 10px;">
                        Cargando vistas...
                    </div>
                </div>
                <button class="reload-button active" onclick="showCreateViewDialog()" style="margin-top: 10px; width: 100%; background: #667eea;">
                    ‚ûï Crear Vista
                </button>
            </div>
            
            <div class="query-panel">
                <div class="query-editor">
                    <label for="queryInput">
                        üîç Editor SQL
                        <span class="info-badge">PostgreSQL</span>
                    </label>
                    
                    <div class="sql-helpers">
                        <div class="sql-helpers-title">‚ö° Cl√°usulas SQL (click para insertar en cursor)</div>
                        <button class="sql-btn" onclick="insertAtCursor('SELECT ')">SELECT</button>
                        <button class="sql-btn" onclick="insertAtCursor('FROM ')">FROM</button>
                        <button class="sql-btn" onclick="insertAtCursor('WHERE ')">WHERE</button>
                        <button class="sql-btn" onclick="insertAtCursor('AND ')">AND</button>
                        <button class="sql-btn" onclick="insertAtCursor('OR ')">OR</button>
                        <button class="sql-btn" onclick="insertAtCursor('GROUP BY ')">GROUP BY</button>
                        <button class="sql-btn" onclick="insertAtCursor('HAVING ')">HAVING</button>
                        <button class="sql-btn" onclick="insertAtCursor('ORDER BY ')">ORDER BY</button>
                        <button class="sql-btn" onclick="insertAtCursor('LIMIT ')">LIMIT</button>
                        <button class="sql-btn" onclick="insertAtCursor('OFFSET ')">OFFSET</button>
                        <button class="sql-btn" onclick="insertAtCursor('JOIN ')">JOIN</button>
                        <button class="sql-btn" onclick="insertAtCursor('LEFT JOIN ')">LEFT JOIN</button>
                        <button class="sql-btn" onclick="insertAtCursor('INNER JOIN ')">INNER JOIN</button>
                        <button class="sql-btn" onclick="insertAtCursor('ON ')">ON</button>
                        <button class="sql-btn" onclick="insertAtCursor('COUNT(*)')">COUNT(*)</button>
                        <button class="sql-btn" onclick="insertAtCursor('COUNT(DISTINCT )')">COUNT DISTINCT</button>
                        <button class="sql-btn" onclick="insertAtCursor('SUM()')">SUM</button>
                        <button class="sql-btn" onclick="insertAtCursor('AVG()')">AVG</button>
                        <button class="sql-btn" onclick="insertAtCursor('MAX()')">MAX</button>
                        <button class="sql-btn" onclick="insertAtCursor('MIN()')">MIN</button>
                        <button class="sql-btn" onclick="insertAtCursor('AS ')">AS</button>
                        <button class="sql-btn" onclick="insertAtCursor('DISTINCT ')">DISTINCT</button>
                        <button class="sql-btn" onclick="insertAtCursor('IN ()')">IN</button>
                        <button class="sql-btn" onclick="insertAtCursor('LIKE \'%%\'')">LIKE</button>
                        <button class="sql-btn" onclick="insertAtCursor('IS NULL')">IS NULL</button>
                        <button class="sql-btn" onclick="insertAtCursor('IS NOT NULL')">IS NOT NULL</button>
                        <button class="sql-btn" onclick="insertAtCursor('BETWEEN ')">BETWEEN</button>
                        <button class="sql-btn" onclick="insertAtCursor('CASE WHEN  THEN  END')">CASE</button>
                    </div>
                    
                    <div class="autocomplete-container">
                        <textarea id="queryInput" placeholder="Escribe tu consulta SQL aqu√≠...&#10;&#10;Ejemplo:&#10;SELECT * FROM products LIMIT 10;"></textarea>
                        <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn-execute" onclick="executeQuery()">‚ñ∂Ô∏è Ejecutar Query</button>
                    <button class="btn-clear" onclick="clearQuery()">üóëÔ∏è Limpiar</button>
                </div>
                
                <div id="results"></div>
            </div>
            
            <div class="tables-sidebar">
                <h3>üóÑÔ∏è Tablas Disponibles</h3>
                <div id="tablesContainer">
                    <div class="loading">Cargando tablas</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Variables globales para autocompletado
        let allTables = [];
        let allColumns = {};
        let sqlKeywords = [
            'SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'NOT', 'IN', 'LIKE', 'BETWEEN',
            'GROUP BY', 'HAVING', 'ORDER BY', 'ASC', 'DESC', 'LIMIT', 'OFFSET',
            'JOIN', 'INNER JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'FULL JOIN', 'ON',
            'COUNT', 'SUM', 'AVG', 'MAX', 'MIN', 'DISTINCT', 'AS',
            'INSERT INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE FROM',
            'CREATE TABLE', 'DROP TABLE', 'ALTER TABLE',
            'IS NULL', 'IS NOT NULL', 'CASE', 'WHEN', 'THEN', 'ELSE', 'END'
        ];
        
        // Cargar tablas al inicio
        window.addEventListener('DOMContentLoaded', () => {
            loadTables();
            setupAutocomplete();
        });
        
        async function loadTables() {
            const container = document.getElementById('tablesContainer');
            
            try {
                const response = await fetch('/tables');
                const result = await response.json();
                
                if (result.success && result.data) {
                    let html = '';
                    
                    // Guardar nombres de tablas para autocompletado
                    allTables = result.data.map(row => row.table_name);
                    
                    for (const row of result.data) {
                        const tableName = row.table_name;
                        const rowCount = row.row_count || 0;
                        html += `
                            <div class="table-item">
                                <div class="table-name">
                                    <div class="table-info">
                                        <span class="clickable-table" onclick="insertTableQuery('${tableName}')">üìã ${tableName}</span>
                                        <span class="row-count-badge">${rowCount} filas</span>
                                    </div>
                                    <span class="toggle-schema" onclick="toggleSchema('${tableName}')">ver +</span>
                                </div>
                                <div class="table-schema" id="schema-${tableName}">
                                    <div class="loading" style="font-size: 10px;">Cargando esquema</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                    
                    // Precargar esquemas
                    for (const row of result.data) {
                        loadSchema(row.table_name);
                    }
                } else {
                    container.innerHTML = '<div style="color: #999; font-size: 12px;">No hay tablas</div>';
                }
            } catch (error) {
                container.innerHTML = `<div style="color: #f44336; font-size: 12px;">Error: ${error.message}</div>`;
            }
        }
        
        async function loadSchema(tableName) {
            try {
                const response = await fetch(`/schema/${tableName}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const schemaDiv = document.getElementById(`schema-${tableName}`);
                    let html = '';
                    
                    for (const col of result.data) {
                        html += `
                            <div class="schema-column">
                                <span class="column-name">${col.column_name}</span>
                                <span class="column-type"> : ${col.data_type}</span>
                            </div>
                        `;
                    }
                    
                    schemaDiv.innerHTML = html;
                    
                    // Guardar columnas para autocompletado
                    allColumns[tableName] = result.data.map(col => col.column_name);
                }
            } catch (error) {
                console.error('Error loading schema:', error);
            }
        }
        
        function setupAutocomplete() {
            const queryInput = document.getElementById('queryInput');
            const suggestionsDiv = document.getElementById('autocompleteSuggestions');
            let selectedIndex = -1;
            
            queryInput.addEventListener('input', function(e) {
                const cursorPos = this.selectionStart;
                const textBeforeCursor = this.value.substring(0, cursorPos);
                const lastWord = textBeforeCursor.split(/\s+/).pop().toUpperCase();
                
                if (lastWord.length < 2) {
                    suggestionsDiv.classList.remove('active');
                    return;
                }
                
                // Buscar coincidencias
                let suggestions = [];
                
                // Keywords SQL
                sqlKeywords.forEach(keyword => {
                    if (keyword.startsWith(lastWord)) {
                        suggestions.push({ text: keyword, type: 'keyword' });
                    }
                });
                
                // Tablas
                allTables.forEach(table => {
                    if (table.toUpperCase().includes(lastWord)) {
                        suggestions.push({ text: table, type: 'table' });
                    }
                });
                
                // Columnas
                Object.values(allColumns).flat().forEach(column => {
                    if (column.toUpperCase().includes(lastWord) && !suggestions.find(s => s.text === column)) {
                        suggestions.push({ text: column, type: 'column' });
                    }
                });
                
                if (suggestions.length > 0) {
                    showSuggestions(suggestions, lastWord);
                    selectedIndex = -1;
                } else {
                    suggestionsDiv.classList.remove('active');
                }
            });
            
            queryInput.addEventListener('keydown', function(e) {
                const items = suggestionsDiv.querySelectorAll('.autocomplete-item');
                
                if (!suggestionsDiv.classList.contains('active')) return;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = (selectedIndex + 1) % items.length;
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
                    updateSelection(items);
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    items[selectedIndex].click();
                } else if (e.key === 'Escape') {
                    suggestionsDiv.classList.remove('active');
                }
            });
            
            // Cerrar al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!queryInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.remove('active');
                }
            });
        }
        
        function showSuggestions(suggestions, searchTerm) {
            const suggestionsDiv = document.getElementById('autocompleteSuggestions');
            const queryInput = document.getElementById('queryInput');
            
            // Limitar a 10 sugerencias
            suggestions = suggestions.slice(0, 10);
            
            let html = '';
            suggestions.forEach((suggestion, index) => {
                html += `
                    <div class="autocomplete-item" onclick="acceptSuggestion('${suggestion.text.replace(/'/g, "\\'")}', '${searchTerm}')">
                        <span>${suggestion.text}</span>
                        <span class="autocomplete-type ${suggestion.type}">${suggestion.type}</span>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.classList.add('active');
            
            // Posicionar el div de sugerencias
            const rect = queryInput.getBoundingClientRect();
            suggestionsDiv.style.top = (rect.bottom - rect.top) + 'px';
            suggestionsDiv.style.left = '15px';
        }
        
        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        function acceptSuggestion(suggestion, searchTerm) {
            const queryInput = document.getElementById('queryInput');
            const cursorPos = queryInput.selectionStart;
            const textBeforeCursor = queryInput.value.substring(0, cursorPos);
            const textAfterCursor = queryInput.value.substring(cursorPos);
            
            // Reemplazar la √∫ltima palabra con la sugerencia
            const words = textBeforeCursor.split(/\s+/);
            words.pop(); // Quitar √∫ltima palabra
            const newTextBefore = words.join(' ') + (words.length > 0 ? ' ' : '') + suggestion + ' ';
            
            queryInput.value = newTextBefore + textAfterCursor;
            queryInput.selectionStart = queryInput.selectionEnd = newTextBefore.length;
            queryInput.focus();
            
            document.getElementById('autocompleteSuggestions').classList.remove('active');
        }
        
        function toggleSchema(tableName) {
            const schemaDiv = document.getElementById(`schema-${tableName}`);
            const toggleBtn = event.target;
            
            if (schemaDiv.classList.contains('visible')) {
                schemaDiv.classList.remove('visible');
                toggleBtn.textContent = 'ver +';
            } else {
                schemaDiv.classList.add('visible');
                toggleBtn.textContent = 'ocultar -';
            }
        }
        
        function insertTableQuery(tableName) {
            insertAtCursor(tableName);
        }
        
        function insertAtCursor(text) {
            const queryInput = document.getElementById('queryInput');
            const startPos = queryInput.selectionStart;
            const endPos = queryInput.selectionEnd;
            const currentValue = queryInput.value;
            
            // Insertar texto en la posici√≥n del cursor
            const newValue = currentValue.substring(0, startPos) + text + currentValue.substring(endPos);
            queryInput.value = newValue;
            
            // Posicionar cursor despu√©s del texto insertado
            // Para funciones con par√©ntesis, posicionar dentro
            let cursorPosition = startPos + text.length;
            if (text.includes('()') && !text.includes('COUNT(*)')) {
                cursorPosition = startPos + text.indexOf('()') + 1;
            } else if (text.includes('\'%%\'')) {
                cursorPosition = startPos + text.indexOf('%%');
            } else if (text.includes('CASE WHEN')) {
                cursorPosition = startPos + 10; // Despu√©s de "CASE WHEN "
            }
            
            queryInput.focus();
            queryInput.setSelectionRange(cursorPosition, cursorPosition);
            
            // Efecto visual
            queryInput.style.background = '#fff3cd';
            setTimeout(() => {
                queryInput.style.background = '#f5f5f5';
            }, 200);
        }
        
        function showColumnInfo(columnName, frequency) {
            const queryInput = document.getElementById('queryInput');
            
            // Generar query que muestre la columna en todas las tablas que la tienen
            const query = `-- Columna "${columnName}" aparece en ${frequency} tabla(s)
-- Puedes modificar esta consulta seg√∫n tus necesidades

SELECT ${columnName}
FROM (
    SELECT table_name 
    FROM information_schema.columns 
    WHERE column_name = '${columnName}' 
    AND table_schema = 'public'
    LIMIT 1
) t;

-- Ejemplo: Ver valores √∫nicos de esta columna
-- SELECT DISTINCT ${columnName} FROM [nombre_tabla];

-- Ejemplo: Contar valores
-- SELECT ${columnName}, COUNT(*) FROM [nombre_tabla] GROUP BY ${columnName};`;
            
            queryInput.value = query;
            queryInput.focus();
            
            // Efecto visual
            queryInput.style.background = '#e3f2fd';
            setTimeout(() => {
                queryInput.style.background = '#f5f5f5';
            }, 300);
        }
        
        function loadQuery(query) {
            document.getElementById('queryInput').value = query.trim();
        }
        
        async function startScraping() {
            const searchTerm = document.getElementById('searchTermInput').value.trim();
            const numProducts = parseInt(document.getElementById('numProductsInput').value) || 50;
            const statusDiv = document.getElementById('scraperStatus');
            const scrapeBtn = document.getElementById('scrapeBtn');
            const progressContainer = document.getElementById('progressContainer');
            const reloadBtn = document.getElementById('reloadBtn');
            
            if (!searchTerm) {
                statusDiv.className = 'scraper-status active error';
                statusDiv.textContent = '‚ö†Ô∏è Por favor ingresa un t√©rmino de b√∫squeda';
                return;
            }
            
            // Validar n√∫mero
            if (numProducts < 1 || numProducts > 200) {
                statusDiv.className = 'scraper-status active error';
                statusDiv.textContent = '‚ö†Ô∏è El n√∫mero de productos debe estar entre 1 y 200';
                return;
            }
            
            // Resetear interfaz
            progressContainer.className = 'progress-container active';
            statusDiv.className = 'scraper-status';
            reloadBtn.className = 'reload-button';
            scrapeBtn.disabled = true;
            scrapeBtn.textContent = '‚è≥ Scraping en progreso...';
            
            // Resetear todos los pasos
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).className = 'progress-step';
                document.getElementById(`progress${i}-bar`).style.width = '0%';
                document.getElementById(`progress${i}-bar`).className = 'progress-bar';
                document.getElementById(`progress${i}-percent`).textContent = '0%';
                document.getElementById(`progress${i}-msg`).textContent = 'Esperando...';
            }
            
            try {
                // Iniciar scraping
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        search_term: searchTerm,
                        num_products: numProducts
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    statusDiv.className = 'scraper-status active error';
                    statusDiv.textContent = `‚ùå Error: ${result.error}`;
                    scrapeBtn.disabled = false;
                    scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                    progressContainer.className = 'progress-container';
                    return;
                }
                
                // Conectar al stream de progreso (SSE)
                const jobId = result.job_id;
                const eventSource = new EventSource(`/scrape/progress/${jobId}`);
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    // Ignorar keepalive
                    if (data.keepalive) return;
                    
                    // Actualizar paso espec√≠fico
                    const step = data.step;
                    const stepEl = document.getElementById(`step${step}`);
                    const barEl = document.getElementById(`progress${step}-bar`);
                    const percentEl = document.getElementById(`progress${step}-percent`);
                    const msgEl = document.getElementById(`progress${step}-msg`);
                    
                    // Actualizar clase del paso
                    stepEl.className = `progress-step ${data.status}`;
                    
                    // Actualizar barra de progreso solo si hay un nuevo valor
                    if (data.progress !== undefined) {
                        barEl.style.width = `${data.progress}%`;
                        percentEl.textContent = `${data.progress}%`;
                    }
                    
                    // Actualizar clase de la barra
                    if (data.status === 'completed') {
                        barEl.className = 'progress-bar completed';
                        barEl.style.width = '100%';
                        percentEl.textContent = '100%';
                    } else if (data.status === 'error') {
                        barEl.className = 'progress-bar error';
                    }
                    
                    // Actualizar mensaje
                    msgEl.textContent = data.message;
                    
                    // Si es el √∫ltimo paso y est√° completado, mostrar bot√≥n de recarga
                    if (step === 4 && data.status === 'completed') {
                        reloadBtn.className = 'reload-button active';
                        scrapeBtn.disabled = false;
                        scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                        
                        // Auto-reload de tablas
                        loadTables();
                    }
                    
                    // Si hay error en alg√∫n paso
                    if (data.status === 'error') {
                        eventSource.close();
                        scrapeBtn.disabled = false;
                        scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                        statusDiv.className = 'scraper-status active error';
                        statusDiv.textContent = '‚ùå El proceso fall√≥. Revisa los pasos anteriores.';
                    }
                };
                
                eventSource.onerror = function(error) {
                    console.error('EventSource error:', error);
                    eventSource.close();
                    scrapeBtn.disabled = false;
                    scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                };
                
            } catch (error) {
                statusDiv.className = 'scraper-status active error';
                statusDiv.textContent = `‚ùå Error de conexi√≥n: ${error.message}`;
                scrapeBtn.disabled = false;
                scrapeBtn.textContent = 'üöÄ Iniciar Scraping';
                progressContainer.className = 'progress-container';
            }
        }
        
        // Permitir scraping con Enter
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchTermInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    startScraping();
                }
            });
        });
        
        function clearQuery() {
            document.getElementById('queryInput').value = '';
            document.getElementById('results').innerHTML = '';
        }
        
        async function executeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            const resultsDiv = document.getElementById('results');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="error-message">‚ö†Ô∏è Por favor ingresa una consulta SQL</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">Ejecutando consulta</div>';
            
            try {
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.data) {
                        displayResults(result);
                    } else {
                        resultsDiv.innerHTML = `<div class="success-message">‚úÖ ${result.message}</div>`;
                    }
                } else {
                    resultsDiv.innerHTML = `<div class="error-message">‚ùå Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error-message">‚ùå Error de conexi√≥n: ${error.message}</div>`;
            }
        }
        
        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            
            let html = '<div class="results-section">';
            html += '<div class="results-header">';
            html += `<div class="results-stats">üìä <strong>${result.row_count}</strong> filas encontradas</div>`;
            html += '</div>';
            
            if (result.data.length > 0) {
                html += '<div class="table-container">';
                html += '<table>';
                html += '<thead><tr>';
                
                result.columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                
                html += '</tr></thead><tbody>';
                
                result.data.forEach(row => {
                    html += '<tr>';
                    result.columns.forEach(col => {
                        let value = row[col];
                        if (value === null) value = '<em style="color: #999;">NULL</em>';
                        else if (typeof value === 'object') value = JSON.stringify(value);
                        else if (typeof value === 'boolean') value = value ? '‚úì' : '‚úó';
                        html += `<td>${value}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += '</div>';
            } else {
                html += '<div style="padding: 20px; text-align: center; color: #666;">No se encontraron resultados</div>';
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        // Permitir ejecutar con Ctrl+Enter
        document.getElementById('queryInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery();
            }
        });
    </script>
    
    <!-- Modal para crear vista -->
    <div class="modal-overlay" id="createViewModal">
        <div class="modal">
            <h3>‚ûï Crear Nueva Vista</h3>
            <p style="color: #666; font-size: 13px;">Guarda la consulta actual como una vista reutilizable</p>
            
            <label for="viewNameInput" style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre de la vista:</label>
            <input type="text" id="viewNameInput" placeholder="mi_vista_productos" style="margin-bottom: 15px;">
            <small style="color: #666;">Solo letras min√∫sculas, n√∫meros y gui√≥n bajo (_)</small>
            
            <label for="viewQueryInput" style="display: block; margin: 15px 0 5px 0; font-weight: 600;">Consulta SQL:</label>
            <textarea id="viewQueryInput" style="width: 100%; height: 150px; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical;"></textarea>
            
            <div class="modal-buttons">
                <button onclick="closeCreateViewDialog()" style="background: #6c757d; color: white;">Cancelar</button>
                <button onclick="createView()" style="background: #667eea; color: white;">Crear Vista</button>
            </div>
        </div>
    </div>
    
    <script>
        // Cargar vistas al iniciar
        loadViews();
        
        function loadViews() {
            fetch('/views')
                .then(response => response.json())
                .then(data => {
                    const viewsList = document.getElementById('viewsList');
                    
                    if (data.success && data.views.length > 0) {
                        viewsList.innerHTML = data.views.map(view => `
                            <div class="view-item" onclick="insertAtCursor('${view.name}')">
                                <div class="view-name">
                                    <span>üìä ${view.name}</span>
                                    <span class="view-delete" onclick="event.stopPropagation(); deleteView('${view.name}')">üóëÔ∏è</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        viewsList.innerHTML = '<div style="color: #999; font-size: 12px; padding: 10px;">No hay vistas guardadas</div>';
                    }
                })
                .catch(error => {
                    console.error('Error cargando vistas:', error);
                    document.getElementById('viewsList').innerHTML = '<div style="color: #dc3545; font-size: 12px; padding: 10px;">Error al cargar vistas</div>';
                });
        }
        
        function showCreateViewDialog() {
            const queryInput = document.getElementById('queryInput');
            const currentQuery = queryInput.value.trim();
            
            if (!currentQuery) {
                alert('‚ö†Ô∏è Primero escribe una consulta SQL para guardar como vista');
                return;
            }
            
            document.getElementById('viewQueryInput').value = currentQuery;
            document.getElementById('viewNameInput').value = '';
            document.getElementById('createViewModal').classList.add('show');
        }
        
        function closeCreateViewDialog() {
            document.getElementById('createViewModal').classList.remove('show');
        }
        
        function createView() {
            const viewName = document.getElementById('viewNameInput').value.trim();
            const query = document.getElementById('viewQueryInput').value.trim();
            
            if (!viewName || !query) {
                alert('‚ö†Ô∏è El nombre y la consulta son requeridos');
                return;
            }
            
            fetch('/views/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    view_name: viewName,
                    query: query
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    closeCreateViewDialog();
                    loadViews();
                    loadSchema(); // Recargar esquema para incluir la nueva vista
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå Error al crear vista: ' + error);
            });
        }
        
        function deleteView(viewName) {
            if (!confirm(`¬øEst√°s seguro de eliminar la vista "${viewName}"?`)) {
                return;
            }
            
            fetch(`/views/drop/${viewName}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    loadViews();
                    loadSchema(); // Recargar esquema
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('‚ùå Error al eliminar vista: ' + error);
            });
        }
        
        // Cerrar modal al hacer click fuera
        document.getElementById('createViewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateViewDialog();
            }
        });
    </script>
</body>
</html>
